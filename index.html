<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Mutt Finder</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
        }

        .micro-field-card {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
            animation: pulse-red 2s ease-in-out infinite;
        }

        .opportunity-card {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3);
            animation: pulse-orange 2s ease-in-out infinite;
        }

        @keyframes pulse-red {

            0%,
            100% {
                box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
            }

            50% {
                box-shadow: 0 15px 40px rgba(239, 68, 68, 0.6);
            }
        }

        @keyframes pulse-orange {

            0%,
            100% {
                box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3);
            }

            50% {
                box-shadow: 0 15px 40px rgba(249, 115, 22, 0.5);
            }
        }

        .countdown {
            font-variant-numeric: tabular-nums;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Standard greyhound box colors */
        /* Standard Australian Greyhound Box Colors */
        .box-1 {
            background: #ef4444;
            /* Red */
        }

        .box-2 {
            background: repeating-linear-gradient(180deg,
                    #000000,
                    #000000 5px,
                    #ffffff 5px,
                    #ffffff 10px);
            color: #ef4444;
            /* Red numbers */
            text-shadow: 0 0 1px #fff;
        }

        .box-3 {
            background: #ffffff;
            /* White */
            color: #000000;
        }

        .box-4 {
            background: #2563eb;
            /* Blue */
        }

        .box-5 {
            background: #eab308;
            /* Yellow */
            color: #000000;
        }

        .box-6 {
            background: #16a34a;
            /* Green */
        }

        .box-7 {
            background: #000000;
            /* Black */
        }

        .box-8 {
            background: #ec4899;
            /* Pink */
        }

        .box-9 {
            background: repeating-linear-gradient(45deg,
                    #16a34a,
                    #16a34a 5px,
                    #ffffff 5px,
                    #ffffff 10px);
            color: #000000;
            text-shadow: 0 0 2px #fff;
        }

        .box-10 {
            background: linear-gradient(to right, #ef4444 33%, #ffffff 33%, #ffffff 66%, #2563eb 66%);
            color: #000000;
            text-shadow: 0 0 2px #fff;
        }

        /* Responsive grid */
        @media (min-width: 768px) {
            .races-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
    </style>
</head>

<body class="min-h-screen text-white">

    <!-- Header -->
    <header class="bg-zinc-900/90 backdrop-blur-lg border-b border-zinc-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-base md:text-xl font-bold text-center">
                üêï 4 Mutt Finder
            </h1>
            <p class="text-center text-zinc-500 text-xs mt-1">
                Live tracking of 4 & 5 runners
            </p>


            <!-- View Toggles -->
            <div class="flex justify-center gap-2 mt-4">
                <button id="btnUpcoming" onclick="setView('upcoming')"
                    class="px-4 py-1.5 rounded-full text-sm font-bold bg-white text-black transition">
                    Upcoming
                </button>
                <button id="btnHistory" onclick="setView('history')"
                    class="px-4 py-1.5 rounded-full text-sm font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">
                    History
                </button>
            </div>

            <!-- Date Filter (only visible in Upcoming view) -->
            <div id="dateFilter" class="flex justify-center gap-2 mt-3">
                <button id="btnAll" onclick="setDateFilter('all')"
                    class="px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition">
                    All
                </button>
                <button id="btnToday" onclick="setDateFilter('today')"
                    class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">
                    Today
                </button>
                <button id="btnTomorrow" onclick="setDateFilter('tomorrow')"
                    class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">
                    Tomorrow
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">

        <!-- Stats Bar -->
        <div id="statsUpcoming" class="grid grid-cols-2 gap-2 mb-3">
            <!-- 4 Runners -->
            <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-[10px] font-bold text-zinc-400 uppercase">4 Runners</div>
                    <div class="text-xl font-bold text-red-500" id="stats4Total">-</div>
                </div>
                <div class="flex justify-between text-[10px] text-zinc-500 border-t border-zinc-800 pt-1">
                    <div>Today: <span id="stats4Today" class="text-white font-bold ml-1">-</span></div>
                    <div>Tmr: <span id="stats4Tomorrow" class="text-white font-bold ml-1">-</span></div>
                </div>
            </div>
            <!-- 5 Runners -->
            <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-[10px] font-bold text-zinc-400 uppercase">5 Runners</div>
                    <div class="text-xl font-bold text-orange-500" id="stats5Total">-</div>
                </div>
                <div class="flex justify-between text-[10px] text-zinc-500 border-t border-zinc-800 pt-1">
                    <div>Today: <span id="stats5Today" class="text-white font-bold ml-1">-</span></div>
                    <div>Tmr: <span id="stats5Tomorrow" class="text-white font-bold ml-1">-</span></div>
                </div>
            </div>
        </div>

        <!-- Stats Bar for History View (Top 2 in Top 2 Strike Rates) -->
        <div id="statsHistory" class="hidden mb-3">
            <!-- Top Row: 4 & 5 Runners (Larger) -->
            <div class="grid grid-cols-2 gap-2 mb-2">
                <!-- 4 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-3 border border-zinc-800">
                    <div class="text-xs font-bold text-zinc-400 uppercase mb-2">4 Runners</div>
                    <div class="text-2xl font-bold text-red-500" id="statsHistory4">-</div>
                    <div class="text-xs text-zinc-500 mt-1" id="statsHistory4Pct">-</div>
                    <div class="text-[9px] text-zinc-600 uppercase mt-0.5 tracking-wide">Top 2 in Top 2 Strike Rate
                    </div>
                </div>
                <!-- 5 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-3 border border-zinc-800">
                    <div class="text-xs font-bold text-zinc-400 uppercase mb-2">5 Runners</div>
                    <div class="text-2xl font-bold text-orange-500" id="statsHistory5">-</div>
                    <div class="text-xs text-zinc-500 mt-1" id="statsHistory5Pct">-</div>
                    <div class="text-[9px] text-zinc-600 uppercase mt-0.5 tracking-wide">Top 2 in Top 2 Strike Rate
                    </div>
                </div>
            </div>

            <!-- Bottom Row: 6, 7, 8, All (Smaller) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <!-- 6 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">6 Runners</div>
                    <div class="text-sm font-bold text-yellow-500" id="statsHistory6">-</div>
                    <div class="text-[8px] text-zinc-500" id="statsHistory6Pct">-</div>
                </div>
                <!-- 7 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">7 Runners</div>
                    <div class="text-sm font-bold text-green-500" id="statsHistory7">-</div>
                    <div class="text-[8px] text-zinc-500" id="statsHistory7Pct">-</div>
                </div>
                <!-- 8 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">8 Runners</div>
                    <div class="text-sm font-bold text-blue-500" id="statsHistory8">-</div>
                    <div class="text-[8px] text-zinc-500" id="statsHistory8Pct">-</div>
                </div>
                <!-- All Fields -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">All Fields</div>
                    <div class="text-sm font-bold text-white" id="statsHistoryAll">-</div>
                    <div class="text-[8px] text-zinc-500" id="statsHistoryAllPct">-</div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="flex flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p class="text-zinc-400">Loading races...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-red-900/30 border border-red-700 rounded-xl p-6 text-center">
            <p class="text-red-400 font-semibold">‚ö†Ô∏è Error loading races</p>
            <p class="text-zinc-400 text-sm mt-2" id="errorMessage"></p>
            <button onclick="loadRaces()" class="mt-4 px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                Retry
            </button>
        </div>

        <!-- No Races State -->
        <div id="noRacesState"
            class="hidden bg-zinc-900/50 backdrop-blur-lg rounded-xl p-8 text-center border border-zinc-800">
            <p class="text-2xl mb-2">üéØ</p>
            <p class="text-zinc-300 font-semibold">No micro-fields found</p>
            <p class="text-zinc-400 text-sm mt-2">Check back soon for 4-5 runner races</p>
        </div>

        <!-- Races Container -->
        <!-- Races Container -->
        <div id="racesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <!-- Race cards will be inserted here -->
        </div>
        <!-- Race cards will be inserted here -->
        </div>

        <!-- Last Updated -->
        <div class="text-center text-zinc-600 text-sm mt-8">
            Last updated: <span id="lastUpdated">-</span>
        </div>

    </main>

    <!-- Footer -->
    <footer class="text-center text-zinc-600 text-sm py-6 mt-12">
        <p>Data sourced from The Greyhound Recorder</p>
        <p class="mt-1">Updates every 15 minutes</p>
    </footer>

    <script>
        // Configuration - Supabase credentials
        const SUPABASE_URL = 'https://yvnkyakuamvahtiwbneq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bmt5YWt1YW12YWh0aXdibmVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Mzg4MTQsImV4cCI6MjA4NDUxNDgxNH0.-v9LyyRgX2tj9EFCImHo44XxSQcZ4_GmQZw-q7ZTX5I';

        // Initialize Supabase client
        let supabaseClient;
        try {
            if (!window.supabase) throw new Error('Supabase library not loaded. Check connection.');
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.error(e);
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = 'Failed to initialize app: ' + e.message;
        }

        // Safety timeout - if nothing happens in 10s, verify what's wrong
        setTimeout(() => {
            const loading = document.getElementById('loadingState');
            if (!loading.classList.contains('hidden')) {
                // If still loading after 10s, show error or console status
                console.warn('Loading timeout reached');
                loading.innerHTML = `
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-zinc-400">Still loading... (Slow connection?)</p>
                    <p class="text-zinc-600 text-xs mt-2">Check console for errors</p>
                `;
            }
        }, 8000);

        // State
        let countdownIntervals = [];
        let cachedRaces = [];
        let currentView = 'upcoming'; // 'upcoming' or 'history'
        let currentDateFilter = 'all'; // 'all', 'today', or 'tomorrow'

        // Set View mode
        function setView(mode) {
            currentView = mode;
            // Update buttons
            const btnUpcoming = document.getElementById('btnUpcoming');
            const btnHistory = document.getElementById('btnHistory');
            const dateFilter = document.getElementById('dateFilter');
            const statsUpcoming = document.getElementById('statsUpcoming');
            const statsHistory = document.getElementById('statsHistory');

            if (btnUpcoming && btnHistory) {
                if (mode === 'upcoming') {
                    btnUpcoming.className = "px-4 py-1.5 rounded-full text-sm font-bold bg-white text-black transition";
                    btnHistory.className = "px-4 py-1.5 rounded-full text-sm font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";
                    // Show date filter for upcoming view
                    if (dateFilter) dateFilter.style.display = 'flex';
                    // Show upcoming stats, hide history stats
                    if (statsUpcoming) statsUpcoming.classList.remove('hidden');
                    if (statsHistory) statsHistory.classList.add('hidden');
                } else {
                    btnUpcoming.className = "px-4 py-1.5 rounded-full text-sm font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";
                    btnHistory.className = "px-4 py-1.5 rounded-full text-sm font-bold bg-white text-black transition";
                    // Hide date filter for history view
                    if (dateFilter) dateFilter.style.display = 'none';
                    // Show history stats, hide upcoming stats
                    if (statsUpcoming) statsUpcoming.classList.add('hidden');
                    if (statsHistory) statsHistory.classList.remove('hidden');
                }
            }
            if (typeof renderRaces === 'function') {
                renderRaces();
            }
        }

        // Set Date Filter
        function setDateFilter(filter) {
            currentDateFilter = filter;
            // Update buttons
            const btnAll = document.getElementById('btnAll');
            const btnToday = document.getElementById('btnToday');
            const btnTomorrow = document.getElementById('btnTomorrow');

            if (btnAll && btnToday && btnTomorrow) {
                // Reset all buttons
                btnAll.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";
                btnToday.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";
                btnTomorrow.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";

                // Highlight selected button
                if (filter === 'all') {
                    btnAll.className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                } else if (filter === 'today') {
                    btnToday.className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                } else if (filter === 'tomorrow') {
                    btnTomorrow.className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                }
            }

            if (typeof renderRaces === 'function') {
                renderRaces();
            }
        }

        // Format countdown timer
        function formatCountdown(raceTime) {
            const now = new Date();
            const race = new Date(raceTime);
            const diff = race - now;

            if (diff < 0) {
                return 'FINISHED';
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Format race time
        function formatRaceTime(raceTime) {
            const date = new Date(raceTime);
            return date.toLocaleTimeString('en-AU', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Format date label (Today/Tomorrow)
        function formatDateLabel(raceTime) {
            if (!raceTime) return '';
            // Convert to local date string (YYYY-MM-DD)
            const raceDate = new Date(raceTime);
            const dateStr = raceDate.toLocaleDateString('en-CA');

            const now = new Date();
            const today = now.toLocaleDateString('en-CA');

            // Calculate tomorrow
            const tmr = new Date(now);
            tmr.setDate(tmr.getDate() + 1);
            const tomorrow = tmr.toLocaleDateString('en-CA');

            if (dateStr === today) {
                return 'Today';
            } else if (dateStr === tomorrow) {
                return 'Tomorrow';
            } else {
                return dateStr; // Fallback to YYYY-MM-DD
            }
        }

        // Create race card HTML
        function createRaceCard(race, runners) {
            const isMicroField = race.active_runner_count === 4;
            const isResulted = race.status === 'resulted' || (race.top_2_in_top_2 !== null);

            const cardClass = isMicroField ? 'micro-field-card' : 'opportunity-card';
            // Badge text is now just the runner count
            const badgeText = isMicroField ? '4 RUNNERS' : '5 RUNNERS';
            const badgeColor = isMicroField ? 'bg-red-900' : 'bg-orange-900';

            // Sort logic
            let sortedRunners = [...runners];
            if (isResulted) {
                // Sort by finishing position (1, 2, 3...) then box
                sortedRunners.sort((a, b) => {
                    // Pull nulls/undefined to the bottom
                    const posA = a.finishing_position || 999;
                    const posB = b.finishing_position || 999;
                    if (posA !== posB) return posA - posB;
                    // Tie-breaker: box number
                    return a.box_number - b.box_number;
                });
            } else {
                // Default: Sort by box number
                sortedRunners.sort((a, b) => a.box_number - b.box_number);
            }

            const runnersHTML = sortedRunners.map(runner => {
                const scratchedClass = runner.is_scratched ? 'opacity-50 line-through' : '';
                const ghrOddsText = runner.ghr_odds ? `$${runner.ghr_odds.toFixed(2)}` : '-';

                // For resulted races, show SP. For upcoming, show SB fixed odds.
                let secondOddsLabel = 'SB';
                let secondOddsText = runner.sportsbet_odds ? `$${runner.sportsbet_odds.toFixed(2)}` : '-';
                let secondOddsClass = 'text-blue-300'; // Default SB blue

                if (isResulted) {
                    secondOddsLabel = 'SP';
                    secondOddsText = runner.starting_price ? `$${runner.starting_price.toFixed(2)}` : '-';
                    secondOddsClass = 'text-yellow-300'; // SP in yellow/gold
                }

                const boxClass = `box-${runner.box_number}`;

                // Position Indicator (Gold/Silver/Bronze)
                let posIndicator = '';
                if (isResulted && runner.finishing_position) {
                    if (runner.finishing_position === 1) {
                        posIndicator = `<div class="w-4 text-center font-bold text-yellow-400 mr-1 text-[10px]">1st</div>`;
                    } else if (runner.finishing_position === 2) {
                        posIndicator = `<div class="w-4 text-center font-bold text-zinc-400 mr-1 text-[10px]">2nd</div>`;
                    } else if (runner.finishing_position === 3) {
                        posIndicator = `<div class="w-4 text-center font-bold text-amber-700 mr-1 text-[10px]">3rd</div>`;
                    } else {
                        // Spacer for non-placed runners to align boxes
                        posIndicator = `<div class="w-4 mr-1"></div>`;
                    }
                }

                return `
                    <div class="flex items-center justify-between py-0.5 border-b border-white/5 last:border-0 ${scratchedClass}">
                        <div class="flex items-center min-w-0">
                            ${posIndicator}
                            <div class="w-4 h-4 rounded-full ${boxClass} flex items-center justify-center font-bold text-[9px] flex-shrink-0 mr-1.5">
                                ${runner.box_number}
                            </div>
                            <div class="font-medium text-xs text-white/90 truncate pr-1">${runner.dog_name}</div>
                        </div>
                        <div class="flex gap-1.5 items-center flex-shrink-0">
                            <div class="text-right w-[28px]">
                                <div class="text-[8px] text-white/40 leading-none">GHR</div>
                                <div class="font-bold text-[10px] leading-tight">${ghrOddsText}</div>
                            </div>
                            <div class="text-right w-[28px]">
                                <div class="text-[8px] text-white/40 leading-none">${secondOddsLabel}</div>
                                <div class="font-bold text-[10px] leading-tight ${secondOddsClass}">${secondOddsText}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Resulted Label
            const resultedLabel = isResulted ?
                `<span class="ml-2 text-[10px] bg-green-900/80 text-green-300 px-1.5 py-0.5 rounded uppercase tracking-wider font-bold">Resulted</span>`
                : '';

            return `
                <div class="${cardClass} rounded-lg p-2 text-white transform transition hover:scale-[1.01] hover:shadow-lg">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-1.5 min-w-0 flex-1">
                            <div class="text-[9px] ${badgeColor} px-1.5 rounded-sm text-white/90 font-bold uppercase tracking-wider flex-shrink-0">
                                ${badgeText}
                            </div>
                            <h2 class="text-xs font-bold leading-tight truncate text-white/90">
                                ${race.meeting_name} ${race.race_number}
                            </h2>
                        </div>
                        <div class="text-right pl-1 flex-shrink-0 flex items-center">
                            <div class="text-xs font-bold whitespace-nowrap opacity-75">
                                ${formatDateLabel(race.race_time)}
                            </div>
                            ${resultedLabel}
                        </div>
                    </div>
                    
                    <div class="bg-black/20 rounded-md px-1.5 py-0.5 backdrop-blur-sm">
                        ${runnersHTML}
                    </div>
                </div>
            `;
        }

        // Update countdown timers
        function updateCountdowns() {
            const countdownElements = document.querySelectorAll('.countdown');
            countdownElements.forEach(elem => {
                const raceTime = elem.getAttribute('data-race-time');
                elem.textContent = formatCountdown(raceTime);
            });
        }

        // Render Races based on current view info
        function renderRaces() {
            const container = document.getElementById('racesContainer');
            if (!container) return;
            container.innerHTML = '';

            // Filter based on view
            // Use local date for "Today" comparison
            // To be safe, we use the device's local midnight
            // Reset to midnight for comparison by using local YYYY-MM-DD string
            const now = new Date();
            // toLocaleDateString('en-CA') returns "YYYY-MM-DD" in local time
            // This ensures "Today" matches even if UTC date is yesterday
            const todayStr = now.toLocaleDateString('en-CA');

            // Calculate tomorrow's date
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('en-CA');

            let displayRaces = cachedRaces.filter(race => {
                // race_time is ISO string
                if (!race.race_time) return false;

                // Convert UTC race time to local date string for comparison
                const raceDateStr = new Date(race.race_time).toLocaleDateString('en-CA');

                // Filter by view (upcoming vs history)
                let passesViewFilter = false;
                if (currentView === 'upcoming') {
                    passesViewFilter = raceDateStr >= todayStr;
                } else {
                    passesViewFilter = raceDateStr < todayStr;
                }

                if (!passesViewFilter) return false;

                // Filter by runner count (only show 4-5 runners in race cards for both views)
                // Stats will still show all runner counts in History view
                if (![4, 5].includes(race.active_runner_count)) {
                    return false;
                }

                // Filter by Date (Today/Tomorrow/All) - ONLY applied in UPCOMING view
                if (currentView === 'upcoming' && currentDateFilter !== 'all') {
                    if (currentDateFilter === 'today') {
                        if (raceDateStr !== todayStr) return false;
                    } else if (currentDateFilter === 'tomorrow') {
                        if (raceDateStr !== tomorrowStr) return false;
                    }
                }

                return true;
            });

            // Handle empty state
            document.getElementById('noRacesState').classList.add('hidden');
            if (displayRaces.length === 0) {
                document.getElementById('noRacesState').classList.remove('hidden');
                document.getElementById('microFieldCount').textContent = '0';
                document.getElementById('opportunityCount').textContent = '0';
                return; // Nothing else to do
            }

            // Stats Calculation (Global based on cachedRaces, not just view)
            // We want to show stats for "Upcoming" races usually
            // But user asked for breakdown. Let's calculate based on ALL cached races that are Future or Today

            const statsRaces = cachedRaces.filter(race => {
                const rDate = new Date(race.race_time).toLocaleDateString('en-CA');
                return rDate >= todayStr; // Only count Today & Future for the dashboard
            });

            function countStats(runnerCount) {
                const total = statsRaces.filter(r => r.active_runner_count === runnerCount).length;
                const todayCount = statsRaces.filter(r => r.active_runner_count === runnerCount && new Date(r.race_time).toLocaleDateString('en-CA') === todayStr).length;
                // Anything > todayStr is tomorrow+
                const tomorrowCount = statsRaces.filter(r => r.active_runner_count === runnerCount && new Date(r.race_time).toLocaleDateString('en-CA') > todayStr).length;
                return { total, todayCount, tomorrowCount };
            }

            const stats4 = countStats(4);
            const stats5 = countStats(5);

            document.getElementById('stats4Total').textContent = stats4.total;
            document.getElementById('stats4Today').textContent = stats4.todayCount;
            document.getElementById('stats4Tomorrow').textContent = stats4.tomorrowCount;

            document.getElementById('stats5Total').textContent = stats5.total;
            document.getElementById('stats5Today').textContent = stats5.todayCount;
            document.getElementById('stats5Tomorrow').textContent = stats5.tomorrowCount;

            // History Stats - Top 2 in Top 2 Strike Rates
            if (currentView === 'history') {
                const historyRaces = cachedRaces.filter(race => {
                    const rDate = new Date(race.race_time).toLocaleDateString('en-CA');
                    return rDate < todayStr && race.top_2_in_top_2 !== null; // Only historical races with results
                });

                function calculateStrikeRate(runnerCount) {
                    const races = historyRaces.filter(r => r.active_runner_count === runnerCount);
                    const total = races.length;
                    const successes = races.filter(r => r.top_2_in_top_2 === true).length;
                    const percentage = total > 0 ? ((successes / total) * 100).toFixed(1) : 0;
                    return { successes, total, percentage };
                }

                const history4 = calculateStrikeRate(4);
                const history5 = calculateStrikeRate(5);
                const history6 = calculateStrikeRate(6);
                const history7 = calculateStrikeRate(7);
                const history8 = calculateStrikeRate(8);

                // All fields combined
                const allTotal = historyRaces.length;
                const allSuccesses = historyRaces.filter(r => r.top_2_in_top_2 === true).length;
                const allPercentage = allTotal > 0 ? ((allSuccesses / allTotal) * 100).toFixed(1) : 0;

                // Update DOM
                document.getElementById('statsHistory4').textContent = `${history4.successes}/${history4.total}`;
                document.getElementById('statsHistory4Pct').textContent = `${history4.percentage}%`;

                document.getElementById('statsHistory5').textContent = `${history5.successes}/${history5.total}`;
                document.getElementById('statsHistory5Pct').textContent = `${history5.percentage}%`;

                document.getElementById('statsHistory6').textContent = `${history6.successes}/${history6.total}`;
                document.getElementById('statsHistory6Pct').textContent = `${history6.percentage}%`;

                document.getElementById('statsHistory7').textContent = `${history7.successes}/${history7.total}`;
                document.getElementById('statsHistory7Pct').textContent = `${history7.percentage}%`;

                document.getElementById('statsHistory8').textContent = `${history8.successes}/${history8.total}`;
                document.getElementById('statsHistory8Pct').textContent = `${history8.percentage}%`;

                document.getElementById('statsHistoryAll').textContent = `${allSuccesses}/${allTotal}`;
                document.getElementById('statsHistoryAllPct').textContent = `${allPercentage}%`;
            }

            // Handle empty state for list
            document.getElementById('noRacesState').classList.add('hidden');
            if (displayRaces.length === 0) {
                document.getElementById('noRacesState').classList.remove('hidden');
                return;
            }

            // Sort logic: Micro-Fields (4) FIRST, then by Date
            const sortedRaces = displayRaces.sort((a, b) => {
                // First: Micro-fields (4) before opportunities (5)
                // This makes ALL 4-runner races appear at the top, regardless of date
                if (a.active_runner_count !== b.active_runner_count) {
                    return a.active_runner_count - b.active_runner_count;
                }

                // Second: Sort by date
                const dateA = new Date(a.race_time).toLocaleDateString('en-CA');
                const dateB = new Date(b.race_time).toLocaleDateString('en-CA');
                if (dateA !== dateB) return dateA.localeCompare(dateB);

                // Third: group by meeting name
                if (a.meeting_name !== b.meeting_name) return a.meeting_name.localeCompare(b.meeting_name);

                // Fourth: race number
                return a.race_number - b.race_number;
            });

            // Add cards
            sortedRaces.forEach(race => {
                const raceRunners = (race.runners || []).sort((a, b) => a.box_number - b.box_number);
                container.innerHTML += createRaceCard(race, raceRunners);
            });
        }

        // Fetch Races from Supabase
        async function fetchRaces() {
            if (!supabaseClient) return; // Don't try if initialization failed
            console.log('Fetching races...');
            try {
                // Show loading state only if no cache
                const loading = document.getElementById('loadingState');
                if (cachedRaces.length === 0) loading.classList.remove('hidden');

                document.getElementById('errorState').classList.add('hidden');

                // Query races with their runners
                // Fetch all races (not just 4-5) so we can show strike rates for all runner counts in History
                const { data: races, error: racesError } = await supabaseClient
                    .from('races')
                    .select('*, runners(*)')  // Optimized join
                    .order('race_time', { ascending: true });

                if (racesError) throw racesError;

                // Update cache
                cachedRaces = races || [];

                // Hide loading state
                loading.classList.add('hidden');

                // Render with current view
                renderRaces();

                // Update last updated time
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('en-AU');

                // Start countdown timer
                clearInterval(window.countdownInterval);
                window.countdownInterval = setInterval(updateCountdowns, 1000);

            } catch (error) {
                console.error('Error loading races:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchRaces();

            // Refresh data every 2 minutes
            setInterval(fetchRaces, 2 * 60 * 1000);
        });
    </script>

</body>

</html>