<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Mutt Finder</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
        }

        .micro-field-card {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
            animation: pulse-red 2s ease-in-out infinite;
        }

        .opportunity-card {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3);
            animation: pulse-orange 2s ease-in-out infinite;
        }

        @keyframes pulse-red {

            0%,
            100% {
                box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
            }

            50% {
                box-shadow: 0 15px 40px rgba(239, 68, 68, 0.6);
            }
        }

        @keyframes pulse-orange {

            0%,
            100% {
                box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3);
            }

            50% {
                box-shadow: 0 15px 40px rgba(249, 115, 22, 0.5);
            }
        }

        .countdown {
            font-variant-numeric: tabular-nums;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Standard greyhound box colors */
        /* Standard Australian Greyhound Box Colors */
        .box-1 {
            background: #ef4444;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .box-2 {
            background: repeating-linear-gradient(180deg,
                    #000000,
                    #000000 5px,
                    #ffffff 5px,
                    #ffffff 10px);
            color: #ef4444 !important;
            /* Force Red */
            font-weight: 900;
            text-shadow: 0 0 2px #ffffff, 0 0 4px #ffffff;
        }

        .box-3 {
            background: #ffffff;
            color: #000000;
        }

        .box-4 {
            background: #2563eb;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .box-5 {
            background: #eab308;
            color: #000000;
        }

        .box-6 {
            background: #16a34a;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .box-7 {
            background: #000000;
            color: #ffffff !important;
            /* Force White */
            font-weight: bold;
        }

        .box-8 {
            background: #ec4899;
            color: black;
        }

        .box-9 {
            background: repeating-linear-gradient(45deg,
                    #16a34a,
                    #16a34a 5px,
                    #ffffff 5px,
                    #ffffff 10px);
            color: #000000;
            text-shadow: 0 0 2px #fff;
        }

        .box-10 {
            background: linear-gradient(to right, #ef4444 33%, #ffffff 33%, #ffffff 66%, #2563eb 66%);
            color: #000000;
            text-shadow: 0 0 2px #fff;
        }

        /* Responsive grid */
        @media (min-width: 768px) {
            .races-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
    </style>
</head>

<body class="min-h-screen text-white">

    <!-- Header -->
    <header class="bg-zinc-900/90 backdrop-blur-lg border-b border-zinc-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-base md:text-xl font-bold text-center">
                üêï 4 Mutt Finder
            </h1>
            <p class="text-center text-zinc-500 text-xs mt-1">
                Live tracking of 4 & 5 runners
            </p>


            <!-- View Toggles -->
            <div class="flex justify-center gap-2 mt-4">
                <button id="btnUpcoming" onclick="setView('upcoming')"
                    class="px-4 py-1.5 rounded-full text-sm font-bold bg-white text-black transition">
                    Upcoming
                </button>
                <button id="btnHistory" onclick="setView('history')"
                    class="px-4 py-1.5 rounded-full text-sm font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">
                    History
                </button>
                <button id="btnStats" onclick="setView('stats')"
                    class="px-4 py-1.5 rounded-full text-sm font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">
                    Stats
                </button>
            </div>

            <!-- Date Filter & Distance Filter (only visible in Upcoming view) -->
            <!-- Filters Container (Date Filters change by view) -->
            <!-- UNIFIED FILTER BAR -->
            <!-- Layout: Flex-Between. Left = Date Filters (Dynamic). Right = Global Filters (Static). -->
            <div id="unifiedFilterBar"
                class="w-full max-w-6xl mx-auto flex flex-wrap items-center justify-between mt-3 px-4 gap-2">

                <!-- LEFT: Date Filters (Context Aware) -->
                <div class="flex items-center gap-2">
                    <!-- Upcoming View Dates -->
                    <div id="dateFiltersUpcoming" class="flex gap-2">
                        <button id="btnAll" onclick="setDateFilter('all')"
                            class="px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition">All</button>
                        <button id="btnToday" onclick="setDateFilter('today')"
                            class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">Today</button>
                        <button id="btnTomorrow" onclick="setDateFilter('tomorrow')"
                            class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">Tomorrow</button>
                    </div>

                    <!-- History/Stats View Dates -->
                    <div id="dateFiltersHistory" class="hidden flex gap-2">
                        <button id="btn3Days" onclick="setStatsDateFilter('3days')"
                            class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">3D</button>
                        <button id="btn7Days" onclick="setStatsDateFilter('7days')"
                            class="px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition">7D</button>
                        <button id="btn90Days" onclick="setStatsDateFilter('90days')"
                            class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">90D</button>
                        <button id="btnAllTime" onclick="setStatsDateFilter('all')"
                            class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">All</button>
                    </div>
                </div>

                <!-- RIGHT: Global Filters (Country, Track, Value) -->
                <!-- Always visible on the right side ("Same Spot") -->
                <div class="flex items-center gap-2">

                    <!-- 1. Smart VALUE Filter (First, as per user request) -->
                    <div id="smartFilterWrapper" class="flex gap-2 border-r border-zinc-700 pr-2">
                        <button id="btnSmartFilter" onclick="toggleSmartFilter()"
                            class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 border border-zinc-700 hover:bg-zinc-700 transition flex items-center gap-1">
                            <span class="text-blue-400">üíé</span> Value Only
                        </button>
                    </div>

                    <!-- 2. Country Filter -->
                    <div class="flex items-center bg-zinc-800 rounded-full p-0.5 border border-zinc-700">
                        <button id="btnCountryAll" onclick="setStatsCountryFilter('all')"
                            class="px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition">All</button>
                        <button id="btnCountryAU" onclick="setStatsCountryFilter('au')"
                            class="px-3 py-1 rounded-full text-xs font-bold text-zinc-400 hover:text-white transition">AU</button>
                        <button id="btnCountryNZ" onclick="setStatsCountryFilter('nz')"
                            class="px-3 py-1 rounded-full text-xs font-bold text-zinc-400 hover:text-white transition">NZ</button>
                    </div>

                    <!-- 3. Runners Filter (Dropdown 2-8) -->
                    <div class="relative">
                        <button id="btnRunnersFilter" onclick="toggleRunnersFilterModal()"
                            class="px-3 py-1.5 rounded-full text-xs font-bold bg-zinc-800 text-zinc-300 border border-zinc-700 hover:bg-zinc-700 transition flex items-center gap-2">
                            <span>üèÉ Runners</span>
                            <span id="runnersFilterCount"
                                class="bg-zinc-700 text-white px-1.5 rounded text-[10px] hidden">0</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-3 h-3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                        <!-- Runners Modal -->
                        <div id="runnersFilterModal"
                            class="hidden absolute right-0 top-full mt-2 w-32 bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl z-50 p-2 flex flex-col">
                            <div class="flex justify-between items-center mb-1 pb-1 border-b border-zinc-800">
                                <span class="text-[10px] font-bold text-zinc-400">Field Size</span>
                                <button onclick="toggleRunnersFilterModal()"
                                    class="text-zinc-500 hover:text-white">‚úï</button>
                            </div>
                            <div class="flex justify-between mb-1">
                                <button onclick="toggleAllRunners(true)"
                                    class="text-[9px] bg-zinc-800 px-1.5 py-0.5 rounded hover:bg-zinc-700 text-zinc-300">All</button>
                                <button onclick="toggleAllRunners(false)"
                                    class="text-[9px] bg-zinc-800 px-1.5 py-0.5 rounded hover:bg-zinc-700 text-zinc-300">Clear</button>
                            </div>
                            <div id="runnersListContainer" class="space-y-0.5">
                                <!-- Populated by JS -->
                            </div>
                            <div class="mt-2 pt-1 border-t border-zinc-800">
                                <button onclick="applyRunnersFilter()"
                                    class="w-full py-1 rounded bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold transition">Apply</button>
                            </div>
                        </div>
                    </div>

                    <!-- 4. Distance Filter (Dropdown) -->
                    <div class="relative">
                        <button id="btnDistanceFilter" onclick="toggleDistanceFilterModal()"
                            class="px-3 py-1.5 rounded-full text-xs font-bold bg-zinc-800 text-zinc-300 border border-zinc-700 hover:bg-zinc-700 transition flex items-center gap-2">
                            <span>üìè Dist</span>
                            <span id="distanceFilterCount"
                                class="bg-zinc-700 text-white px-1.5 rounded text-[10px] hidden">0</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-3 h-3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                        <!-- Distance Modal -->
                        <div id="distanceFilterModal"
                            class="hidden absolute right-0 top-full mt-2 w-40 bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl z-50 p-2 flex flex-col">
                            <div class="flex justify-between items-center mb-1 pb-1 border-b border-zinc-800">
                                <span class="text-[10px] font-bold text-zinc-400">Distance</span>
                                <button onclick="toggleDistanceFilterModal()"
                                    class="text-zinc-500 hover:text-white">‚úï</button>
                            </div>
                            <div class="flex justify-between mb-1">
                                <button onclick="toggleAllDistances(true)"
                                    class="text-[9px] bg-zinc-800 px-1.5 py-0.5 rounded hover:bg-zinc-700 text-zinc-300">All</button>
                                <button onclick="toggleAllDistances(false)"
                                    class="text-[9px] bg-zinc-800 px-1.5 py-0.5 rounded hover:bg-zinc-700 text-zinc-300">Clear</button>
                            </div>
                            <div id="distanceListContainer" class="space-y-0.5">
                                <!-- Populated by JS -->
                            </div>
                            <div class="mt-2 pt-1 border-t border-zinc-800">
                                <button onclick="applyDistanceFilter()"
                                    class="w-full py-1 rounded bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold transition">Apply</button>
                            </div>
                        </div>
                    </div>

                    <!-- 5. Track Filter Multi-Select -->
                    <div class="relative">
                        <button id="btnTrackFilter" onclick="toggleTrackFilterModal()"
                            class="px-4 py-1.5 rounded-full text-xs font-bold bg-zinc-800 text-zinc-300 border border-zinc-700 hover:bg-zinc-700 transition flex items-center gap-2">
                            <span>üìç Tracks</span>
                            <span id="trackFilterCount"
                                class="bg-zinc-700 text-white px-1.5 rounded text-[10px] hidden">0</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-3 h-3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>

                        <!-- Track Filter Modal -->
                        <div id="trackFilterModal"
                            class="hidden absolute right-0 top-full mt-2 w-64 bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl z-50 p-3 max-h-[60vh] flex flex-col">
                            <div class="flex justify-between items-center mb-2 pb-2 border-b border-zinc-800">
                                <span class="text-xs font-bold text-zinc-400">Select Tracks</span>
                                <button onclick="toggleTrackFilterModal()"
                                    class="text-zinc-500 hover:text-white">‚úï</button>
                            </div>
                            <!-- Search/Helpers -->
                            <div class="flex gap-2 mb-2">
                                <button onclick="toggleAllTracks(true)"
                                    class="text-[10px] bg-zinc-800 px-2 py-1 rounded hover:bg-zinc-700 text-zinc-300">All</button>
                                <button onclick="toggleAllTracks(false)"
                                    class="text-[10px] bg-zinc-800 px-2 py-1 rounded hover:bg-zinc-700 text-zinc-300">Clear</button>
                            </div>
                            <!-- Checkbox List -->
                            <div id="trackListContainer" class="overflow-y-auto flex-1 space-y-1 pr-1 custom-scrollbar">
                            </div>
                            <!-- Apply Button -->
                            <div class="mt-3 pt-2 border-t border-zinc-800">
                                <button onclick="applyTrackFilter()"
                                    class="w-full py-1.5 rounded bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold transition">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters for History & Stats Views -->
            <!-- Filters for History & Stats Views -->

        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">

        <!-- Stats Bar -->
        <div id="statsUpcoming" class="grid grid-cols-3 gap-2 mb-3">
            <!-- 4 Runners -->
            <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-[10px] font-bold text-zinc-400 uppercase">4 Runners</div>
                    <div class="text-xl font-bold text-red-500" id="stats4Total">-</div>
                </div>
                <div class="flex justify-between text-[10px] text-zinc-500 border-t border-zinc-800 pt-1">
                    <div>Today: <span id="stats4Today" class="text-white font-bold ml-1">-</span></div>
                    <div>Tmr: <span id="stats4Tomorrow" class="text-white font-bold ml-1">-</span></div>
                </div>
            </div>
            <!-- 5 Runners -->
            <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-[10px] font-bold text-zinc-400 uppercase">5 Runners</div>
                    <div class="text-xl font-bold text-orange-500" id="stats5Total">-</div>
                </div>
                <div class="flex justify-between text-[10px] text-zinc-500 border-t border-zinc-800 pt-1">
                    <div>Today: <span id="stats5Today" class="text-white font-bold ml-1">-</span></div>
                    <div>Tmr: <span id="stats5Tomorrow" class="text-white font-bold ml-1">-</span></div>
                </div>
            </div>
            <!-- Blue Opps -->
            <div class="bg-blue-900/20 backdrop-blur-lg rounded-lg p-2 border border-blue-800/50">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-[10px] font-bold text-blue-300 uppercase">Top 2 Opps</div>
                    <div class="text-xl font-bold text-blue-400" id="statsBlueTotal">-</div>
                </div>
                <div class="flex justify-between text-[10px] text-zinc-500 border-t border-blue-800/30 pt-1">
                    <div>Today: <span id="statsBlueToday" class="text-white font-bold ml-1">-</span></div>
                    <div>Tmr: <span id="statsBlueTomorrow" class="text-white font-bold ml-1">-</span></div>
                </div>
            </div>
        </div>

        <!-- Stats Bar for History View (Top 2 in Top 2 Strike Rates) -->
        <div id="statsHistory" class="hidden mb-3">
            <!-- Top Row: 4 & 5 Runners (Larger) -->
            <div class="grid grid-cols-2 gap-2 mb-2">
                <!-- 4 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-3 border border-zinc-800">
                    <div class="text-xs font-bold text-zinc-400 uppercase mb-2">4 Runners</div>
                    <div class="text-2xl font-bold text-red-500" id="statsHistory4">-</div>
                    <div class="text-xs text-zinc-300 mt-1" id="statsHistory4Pct">-</div>
                    <div class="text-[9px] text-zinc-400 uppercase mt-0.5 tracking-wide">Top 2 in Top 2 Strike Rate
                    </div>
                </div>
                <!-- 5 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-3 border border-zinc-800">
                    <div class="text-xs font-bold text-zinc-400 uppercase mb-2">5 Runners</div>
                    <div class="text-2xl font-bold text-orange-500" id="statsHistory5">-</div>
                    <div class="text-xs text-zinc-300 mt-1" id="statsHistory5Pct">-</div>
                    <div class="text-[9px] text-zinc-400 uppercase mt-0.5 tracking-wide">Top 2 in Top 2 Strike Rate
                    </div>
                </div>
            </div>

            <!-- Bottom Row: 6, 7, 8, All, Top 2 Opps (Smaller) -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                <!-- 6 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">6 Runners</div>
                    <div class="text-sm font-bold text-yellow-500" id="statsHistory6">-</div>
                    <div class="text-[8px] text-zinc-300" id="statsHistory6Pct">-</div>
                </div>
                <!-- 7 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">7 Runners</div>
                    <div class="text-sm font-bold text-green-500" id="statsHistory7">-</div>
                    <div class="text-[8px] text-zinc-300" id="statsHistory7Pct">-</div>
                </div>
                <!-- 8 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">8 Runners</div>
                    <div class="text-sm font-bold text-blue-500" id="statsHistory8">-</div>
                    <div class="text-[8px] text-zinc-300" id="statsHistory8Pct">-</div>
                </div>
                <!-- All Fields -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">All Fields</div>
                    <div class="text-sm font-bold text-white" id="statsHistoryAll">-</div>
                    <div class="text-[8px] text-zinc-300" id="statsHistoryAllPct">-</div>
                </div>
                <!-- Top 2 Opps -->
                <div class="bg-blue-900/30 backdrop-blur-lg rounded-lg p-2 border border-blue-800/50">
                    <div class="text-[9px] font-bold text-blue-300 uppercase mb-1">Top 2 Opps</div>
                    <div class="text-sm font-bold text-blue-400" id="statsHistoryBlue">-</div>
                    <div class="text-[8px] text-blue-300/80" id="statsHistoryBluePct">-</div>
                </div>
            </div>
        </div>

        <!-- Filter Context Title (Dynamic) -->
        <div id="filterContextTitle" class="text-center text-xs text-zinc-500 mb-4 hidden">
            Showing stats for <span id="filterContextLabel" class="text-zinc-300 font-bold">Last 7 Days</span>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="flex flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p class="text-zinc-400">Loading races...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-red-900/30 border border-red-700 rounded-xl p-6 text-center">
            <p class="text-red-400 font-semibold">‚ö†Ô∏è Error loading races</p>
            <p class="text-zinc-400 text-sm mt-2" id="errorMessage"></p>
            <button onclick="loadRaces()" class="mt-4 px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                Retry
            </button>
        </div>

        <!-- No Races State -->
        <div id="noRacesState"
            class="hidden bg-zinc-900/50 backdrop-blur-lg rounded-xl p-8 text-center border border-zinc-800">
            <p class="text-2xl mb-2">üéØ</p>
            <p class="text-zinc-300 font-semibold">No micro-fields found</p>
            <p class="text-zinc-400 text-sm mt-2">Check back soon for 4-5 runner races</p>
        </div>

        <!-- Races Container -->
        <!-- Races Container -->
        <div id="racesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <!-- Race cards will be inserted here -->
        </div>
        <!-- Race cards will be inserted here -->
        </div>

        <!-- Stats View -->
        <div id="statsView" class="hidden space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 1. General Favourites Stats -->
                <section>
                    <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                        <span>üèÜ</span> Favourites Strike Rate
                    </h3>
                    <div class="overflow-x-auto rounded-lg border border-zinc-800">
                        <table class="w-full text-sm text-left text-zinc-400">
                            <thead class="text-xs text-zinc-200 uppercase bg-zinc-900/50">
                                <tr>
                                    <th class="px-4 py-3">Field Size</th>
                                    <th class="px-4 py-3 text-center">Races</th>
                                    <th class="px-4 py-3 text-center">Fav Wins</th>
                                    <th class="px-4 py-3 text-right">Strike Rate</th>
                                    <th class="px-4 py-3 text-right">P&L ($)</th>
                                    <th class="px-4 py-3 text-right">ROI</th>
                                </tr>
                            </thead>
                            <tbody id="statsFavGeneral" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- 2. Short Priced Favourites (< $2.00) -->
                <section>
                    <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                        <span>üî•</span> Short Priced Favourites (< $2.00) </h3>
                            <div class="overflow-x-auto rounded-lg border border-zinc-800">
                                <table class="w-full text-sm text-left text-zinc-400">
                                    <thead class="text-xs text-zinc-200 uppercase bg-zinc-900/50">
                                        <tr>
                                            <th class="px-4 py-3">Field Size</th>
                                            <th class="px-4 py-3 text-center">Races</th>
                                            <th class="px-4 py-3 text-center">Short Fav Wins</th>
                                            <th class="px-4 py-3 text-right">Strike Rate</th>
                                            <th class="px-4 py-3 text-right">P&L ($)</th>
                                            <th class="px-4 py-3 text-right">ROI</th>
                                        </tr>
                                    </thead>
                                    <tbody id="statsFavShort" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                </section>
            </div>

            <!-- 3. Favourites by Box Number -->
            <section>
                <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                    <span>üì¶</span> Favourites by Box
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- All Favs -->
                    <div>
                        <h4 class="text-sm font-bold text-zinc-400 mb-2 uppercase tracking-wide">All Favourites</h4>
                        <div class="overflow-x-auto rounded-lg border border-zinc-800">
                            <table class="w-full text-xs text-center text-zinc-400">
                                <thead class="text-zinc-200 bg-zinc-900/50 uppercase">
                                    <tr>
                                        <th class="px-2 py-2 text-left">Box</th>
                                        <th class="px-2 py-2">4 Runners</th>
                                        <th class="px-2 py-2">5 Runners</th>
                                        <th class="px-2 py-2">6 Runners</th>
                                        <th class="px-2 py-2">7 Runners</th>
                                        <th class="px-2 py-2">8 Runners</th>
                                        <th class="px-2 py-2 text-white font-bold border-l border-zinc-700">All</th>
                                        <th class="px-2 py-2 text-right border-l border-zinc-700">P&L</th>
                                        <th class="px-2 py-2 text-right">ROI</th>
                                    </tr>
                                </thead>
                                <tbody id="statsBoxAll" class="bg-zinc-900/20 divide-y divide-zinc-800/50"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Short Favs -->
                    <div>
                        <h4 class="text-sm font-bold text-zinc-400 mb-2 uppercase tracking-wide">Short Priced (<
                                $2.00)</h4>
                                <div class="overflow-x-auto rounded-lg border border-zinc-800">
                                    <table class="w-full text-xs text-center text-zinc-400">
                                        <thead class="text-zinc-200 bg-zinc-900/50 uppercase">
                                            <tr>
                                                <th class="px-2 py-2 text-left">Box</th>
                                                <th class="px-2 py-2">4 Runners</th>
                                                <th class="px-2 py-2">5 Runners</th>
                                                <th class="px-2 py-2">6 Runners</th>
                                                <th class="px-2 py-2">7 Runners</th>
                                                <th class="px-2 py-2">8 Runners</th>
                                                <th class="px-2 py-2 text-white font-bold border-l border-zinc-700">All
                                                </th>
                                                <th class="px-2 py-2 text-right border-l border-zinc-700">P&L</th>
                                                <th class="px-2 py-2 text-right">ROI</th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsBoxShort" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                                        </tbody>
                                    </table>
                                </div>
                    </div>
                </div>
            </section>

            <!-- 4. Track Stats -->
            <section>
                <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                    <span>üìç</span> Track Performance
                </h3>
                <div class="overflow-x-auto rounded-lg border border-zinc-800">
                    <table class="w-full text-sm text-left text-zinc-400">
                        <thead class="text-xs text-zinc-200 uppercase bg-zinc-900/50">
                            <tr>
                                <th class="px-4 py-3">Track</th>
                                <th class="px-4 py-3 text-center">Races</th>
                                <th class="px-4 py-3 text-center">Fav Wins</th>
                                <th class="px-4 py-3 text-center">Fav SR%</th>
                                <th class="px-4 py-3 text-center">Short Fav Wins</th>
                                <th class="px-4 py-3 text-center">Short Fav SR%</th>
                            </tr>
                        </thead>
                        <tbody id="statsTracks" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 5. Distance Stats -->
            <section class="mt-6">
                <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                    <span>üìè</span> Distance Performance
                </h3>
                <div class="overflow-x-auto rounded-lg border border-zinc-800">
                    <table class="w-full text-sm text-left text-zinc-400">
                        <thead class="text-xs text-zinc-200 uppercase bg-zinc-900/50">
                            <tr>
                                <!-- JS renders headers -->
                            </tr>
                        </thead>
                        <tbody id="statsDistances" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

        </div>

        <!-- Last Updated -->
        <div class="text-center text-zinc-600 text-sm mt-8">
            Last updated: <span id="lastUpdated">-</span>
        </div>

    </main>

    <!-- Footer -->
    <footer class="text-center text-zinc-600 text-sm py-6 mt-12">
        <p>Data sourced from The Greyhound Recorder</p>
        <p class="mt-1">Updates every 15 minutes</p>
    </footer>

    <script>
        // Configuration - Supabase credentials
        const SUPABASE_URL = 'https://yvnkyakuamvahtiwbneq.supabase.co';
        // NZ Tracks List
        const NZ_TRACKS = new Set([
            'Addington',
            'Hatrick',
            'Cambridge',
            'Ascot Park',
            'Manawatu',
            'Manukau',
            'Wanganui Straight'
        ]);
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bmt5YWt1YW12YWh0aXdibmVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Mzg4MTQsImV4cCI6MjA4NDUxNDgxNH0.-v9LyyRgX2tj9EFCImHo44XxSQcZ4_GmQZw-q7ZTX5I';

        // Initialize Supabase client
        let supabaseClient;
        try {
            if (!window.supabase) throw new Error('Supabase library not loaded. Check connection.');
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.error(e);
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = 'Failed to initialize app: ' + e.message;
        }

        // Safety timeout - if nothing happens in 10s, verify what's wrong
        setTimeout(() => {
            const loading = document.getElementById('loadingState');
            if (!loading.classList.contains('hidden')) {
                // If still loading after 10s, show error or console status
                console.warn('Loading timeout reached');
                loading.innerHTML = `
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-zinc-400">Still loading... (Slow connection?)</p>
                    <p class="text-zinc-600 text-xs mt-2">Check console for errors</p>
                `;
            }
        }, 8000);

        // State
        let countdownIntervals = [];
        let cachedRaces = [];
        let currentView = 'upcoming'; // 'upcoming' or 'history'
        let currentDateFilter = 'all'; // 'all', 'today', or 'tomorrow'
        // currentDistanceFilter moved to Global Filter Logic
        let currentStatsDateFilter = '7days'; // Default to Last 7 Days
        let isSmartFilterActive = false; // "Value Finder" Toggle
        let currentStatsTrackFilter = new Set(); // Empty Set = All Tracks
        let currentStatsCountryFilter = 'all'; // 'all', 'au', 'nz'

        // Set View mode
        function setView(mode) {
            currentView = mode;
            // Update buttons
            const btnUpcoming = document.getElementById('btnUpcoming');
            const btnHistory = document.getElementById('btnHistory');
            const btnStats = document.getElementById('btnStats');

            const filtersContainer = document.getElementById('filtersContainer');
            const statsFiltersContainer = document.getElementById('statsFiltersContainer');
            const filterContextTitle = document.getElementById('filterContextTitle');
            const statsUpcoming = document.getElementById('statsUpcoming');
            const statsHistory = document.getElementById('statsHistory');

            const racesContainer = document.getElementById('racesContainer');
            const statsView = document.getElementById('statsView');

            // Reset all buttons
            const activeClass = "px-4 py-1.5 rounded-full text-sm font-bold bg-white text-black transition";
            const inactiveClass = "px-4 py-1.5 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";

            if (btnUpcoming) btnUpcoming.className = (mode === 'upcoming') ? activeClass : inactiveClass;
            if (btnHistory) btnHistory.className = (mode === 'history') ? activeClass : inactiveClass;
            if (btnStats) btnStats.className = (mode === 'stats') ? activeClass : inactiveClass;

            // Common Visibility (ALWAYS Show Global Filters)
            // Note: globalFiltersContainer is visible by default structure.

            // Container Visibility
            if (mode === 'stats') {
                if (racesContainer) racesContainer.classList.add('hidden');

                // Hide Upcoming Date Filters, Show Stats Date Filters
                if (filtersContainer) filtersContainer.style.display = 'none'; // Legacy container?

                // Unified Filter Bar Toggles
                document.getElementById('dateFiltersUpcoming').classList.add('hidden');
                document.getElementById('dateFiltersHistory').classList.remove('hidden');

                if (statsFiltersContainer) statsFiltersContainer.classList.remove('hidden'); // Legacy?

                if (filterContextTitle) filterContextTitle.classList.remove('hidden');
                if (statsUpcoming) statsUpcoming.classList.add('hidden');
                if (statsHistory) statsHistory.classList.add('hidden');
                if (statsView) statsView.classList.remove('hidden');

                renderStats();
            } else {
                if (statsView) statsView.classList.add('hidden');
                if (racesContainer) racesContainer.classList.remove('hidden');

                if (mode === 'upcoming') {
                    if (filtersContainer) filtersContainer.style.display = 'flex';

                    // Unified Filter Bar Toggles
                    document.getElementById('dateFiltersUpcoming').classList.remove('hidden');
                    document.getElementById('dateFiltersHistory').classList.add('hidden');

                    if (statsFiltersContainer) statsFiltersContainer.classList.add('hidden');
                    if (filterContextTitle) filterContextTitle.classList.add('hidden');
                    if (statsUpcoming) statsUpcoming.classList.remove('hidden');
                    if (statsHistory) statsHistory.classList.add('hidden');
                    document.getElementById('noRacesState').classList.add('hidden');
                } else {
                    // History
                    if (filtersContainer) filtersContainer.style.display = 'none';

                    // Unified Filter Bar Toggles
                    document.getElementById('dateFiltersUpcoming').classList.add('hidden');
                    document.getElementById('dateFiltersHistory').classList.remove('hidden');

                    if (statsFiltersContainer) statsFiltersContainer.classList.remove('hidden');
                    if (filterContextTitle) filterContextTitle.classList.remove('hidden');
                    if (statsUpcoming) statsUpcoming.classList.add('hidden');
                    if (statsHistory) statsHistory.classList.remove('hidden');
                }

                if (typeof renderRaces === 'function') {
                    renderRaces();
                }
            }
        }

        // Render Stats
        function renderStats() {
            // Stats Date Filter Logic
            const getStatsCutoff = () => {
                if (currentStatsDateFilter === 'all') return null;
                const now = new Date();
                now.setHours(0, 0, 0, 0); // Midnight local
                if (currentStatsDateFilter === '3days') now.setDate(now.getDate() - 3);
                else if (currentStatsDateFilter === '7days') now.setDate(now.getDate() - 7);
                else if (currentStatsDateFilter === '90days') now.setDate(now.getDate() - 90);
                return now;
            };

            const cutoffDate = getStatsCutoff();

            // 1. Filter for Resulted Races with valid SPs AND Date Filter
            let resultedRaces = cachedRaces.filter(race => {
                const isResulted = race.status === 'resulted' || race.top_2_in_top_2 !== null;
                if (!isResulted) return false;

                if (cutoffDate) {
                    const rDate = new Date(race.race_time);
                    if (rDate < cutoffDate) return false;
                }
                return true;
                return true;
            });


            // 2. Filter by Track (Cross-Filtering - Multi-Select)
            if (currentStatsTrackFilter.size > 0) {
                resultedRaces = resultedRaces.filter(r => currentStatsTrackFilter.has(r.meeting_name));
            }

            // 3. Filter by Country
            if (currentStatsCountryFilter !== 'all') {
                resultedRaces = resultedRaces.filter(r => {
                    const isNZ = NZ_TRACKS.has(r.meeting_name);
                    const country = isNZ ? 'nz' : 'au';
                    return country === currentStatsCountryFilter;
                });
            }

            // 4. Smart Filter (Value)
            if (isSmartFilterActive) {
                resultedRaces = resultedRaces.filter(race => {
                    const activeRunners = (race.runners || []).filter(r => !r.is_scratched && r.sportsbet_odds > 0);
                    if (activeRunners.length < 2) return false;

                    activeRunners.sort((a, b) => a.sportsbet_odds - b.sportsbet_odds);
                    const fav1 = activeRunners[0];
                    const fav2 = activeRunners[1];

                    if (fav1.sportsbet_odds >= 2.00) return false;

                    const isBlueOpp = isRaceBlueOpp(race);
                    const isSmallField = race.active_runner_count <= 6;
                    if (!isSmallField && !isBlueOpp) return false;

                    const dist = race.distance_meters || 0;
                    if (dist < 350) return false;

                    const badBoxes = [5, 7];
                    if (badBoxes.includes(fav1.box_number)) return false;
                    if (badBoxes.includes(fav2.box_number)) return false;

                    return true;
                });
            }

            // Data Structures
            const fieldSizes = [4, 5, 6, 7, 8];
            const stats = {
                general: {}, // By Field Size
                short: {},   // By Field Size (< $2.00)
                boxGeneral: {}, // By Box (1-8) -> Field Size
                boxShort: {},   // By Box (1-8) -> Field Size
                tracks: {},      // By Track Name
                distances: {}    // By Distance (300m, 400m, etc.)
            };

            // Initialize Grid structures
            fieldSizes.forEach(size => {
                stats.general[size] = { races: 0, wins: 0, profit: 0, bets: 0 };
                stats.short[size] = { races: 0, wins: 0, profit: 0, bets: 0 };
            });

            for (let b = 1; b <= 8; b++) {
                stats.boxGeneral[b] = {};
                stats.boxShort[b] = {};
                fieldSizes.forEach(size => {
                    stats.boxGeneral[b][size] = { runs: 0, wins: 0, profit: 0 };
                    stats.boxShort[b][size] = { runs: 0, wins: 0, profit: 0 };
                });
            }

            // Process Races
            resultedRaces.forEach(race => {
                const runnerCount = race.active_runner_count;
                if (!fieldSizes.includes(runnerCount)) return;

                const runners = race.runners || [];
                // Filter valid runners with SP
                const validRunners = runners.filter(r => r.starting_price !== null && r.starting_price > 0 && !r.is_scratched);
                if (validRunners.length === 0) return;

                // Find Min SP (Favourites)
                const minSP = Math.min(...validRunners.map(r => r.starting_price));
                const favourites = validRunners.filter(r => r.starting_price === minSP);
                const isShortPriced = minSP < 2.00;

                // Track Stats Init
                if (!stats.tracks[race.meeting_name]) {
                    stats.tracks[race.meeting_name] = {
                        races: 0, favWins: 0, shortWins: 0, shortRaces: 0,
                        favBets: 0, shortBets: 0,
                        favProfit: 0, shortProfit: 0,
                        top2in2: 0, races4: 0, top2in2_4: 0,
                        box1FavRuns: 0, box1FavWins: 0, box1FavProfit: 0,
                        box1ShortFavRuns: 0, box1ShortFavWins: 0, box1ShortFavProfit: 0
                    };
                }
                stats.tracks[race.meeting_name].races++;
                if (isShortPriced) stats.tracks[race.meeting_name].shortRaces++;

                // Distance Stats Init & Increment
                const distKey = race.distance_meters ? `${race.distance_meters}m` : 'Unknown';
                if (!stats.distances[distKey]) {
                    stats.distances[distKey] = {
                        races: 0, favWins: 0, shortWins: 0, shortRaces: 0,
                        favBets: 0, shortBets: 0,
                        favProfit: 0, shortProfit: 0,
                        top2in2: 0, races4: 0, top2in2_4: 0,
                        box1FavRuns: 0, box1FavWins: 0, box1FavProfit: 0,
                        box1ShortFavRuns: 0, box1ShortFavWins: 0, box1ShortFavProfit: 0,
                        rawDist: race.distance_meters || 9999
                    };
                }
                stats.distances[distKey].races++;
                if (isShortPriced) stats.distances[distKey].shortRaces++;

                // Track Stats: Top 2 in Top 2
                if (race.top_2_in_top_2 === true) {
                    stats.tracks[race.meeting_name].top2in2++;
                    stats.distances[distKey].top2in2++;
                }

                // Track Stats: 4 Runner Specifics
                if (runnerCount === 4) {
                    stats.tracks[race.meeting_name].races4++;
                    stats.distances[distKey].races4++;
                    if (race.top_2_in_top_2 === true) {
                        stats.tracks[race.meeting_name].top2in2_4++;
                        stats.distances[distKey].top2in2_4++;
                    }
                }

                // General Stats
                stats.general[runnerCount].races++;
                if (isShortPriced) stats.short[runnerCount].races++;

                // Check Win
                let favWon = false;

                // Note: There can be joint favourites. We split stake if needed? 
                // Standard SP logic: If joint favs, user is on "The Favourite". 
                // Usually for stats purposes, if multiple favs, we count all as runs? Or 1 run?
                // Simplification for MVP: If multiple favs, we treat each as a separate "Bet" on a favourite?
                // Yes, standard logic: If you back "The Favourite" and there are 2 equal favs, you back both.
                // Or you back the one with better form.
                // Let's assume we back ALL joint favourites for $1 each.

                favourites.forEach(fav => {
                    let stake = 1;
                    let runProfit = -1 * stake;

                    if (fav.finishing_position === 1) {
                        // Win!
                        // Profit = (SP * Stake) - Stake
                        runProfit = (fav.starting_price * stake) - stake;
                    }

                    // Update Box Stats (Runs & Profit)
                    if (stats.boxGeneral[fav.box_number]) {
                        stats.boxGeneral[fav.box_number][runnerCount].runs++;
                        stats.boxGeneral[fav.box_number][runnerCount].profit += runProfit;

                        if (isShortPriced) {
                            stats.boxShort[fav.box_number][runnerCount].runs++;
                            stats.boxShort[fav.box_number][runnerCount].profit += runProfit;
                        }
                    }

                    // Track & Distance Stats: Box 1 Favs
                    if (fav.box_number === 1) {
                        stats.tracks[race.meeting_name].box1FavRuns++;
                        stats.tracks[race.meeting_name].box1FavProfit += runProfit;

                        stats.distances[distKey].box1FavRuns++;
                        stats.distances[distKey].box1FavProfit += runProfit;

                        if (isShortPriced) {
                            stats.tracks[race.meeting_name].box1ShortFavRuns++;
                            stats.tracks[race.meeting_name].box1ShortFavProfit += runProfit;

                            stats.distances[distKey].box1ShortFavRuns++;
                            stats.distances[distKey].box1ShortFavProfit += runProfit;
                        }
                    }

                    if (fav.finishing_position === 1) {
                        favWon = true; // Use this for "Races where Fav Won" strike rate?
                        // Actually our stats.general[fields].wins is usually "Number of Winning Favourites"
                        // If 2 favs run and 1 wins, is that 1 win 2 runs?
                        // Standard practice: Strike Rate is Wins / Runs.

                        // Update Box Stats (Wins)
                        if (stats.boxGeneral[fav.box_number]) {
                            stats.boxGeneral[fav.box_number][runnerCount].wins++;
                            if (isShortPriced) stats.boxShort[fav.box_number][runnerCount].wins++;
                        }

                        // Track & Distance Stats: Box 1 Fav Wins
                        if (fav.box_number === 1) {
                            stats.tracks[race.meeting_name].box1FavWins++;
                            stats.distances[distKey].box1FavWins++;
                            if (isShortPriced) {
                                stats.tracks[race.meeting_name].box1ShortFavWins++;
                                stats.distances[distKey].box1ShortFavWins++;
                            }
                        }
                    }

                    // Update General/Short Stats Aggregates
                    // We treat these as aggregate Performance of "Backing Favourites"
                    stats.general[runnerCount].profit += runProfit;
                    if (isShortPriced) stats.short[runnerCount].profit += runProfit;

                    // Track & Distance Stats: Overall Fav P&L
                    stats.tracks[race.meeting_name].favBets++;
                    stats.tracks[race.meeting_name].favProfit += runProfit;

                    stats.distances[distKey].favBets++;
                    stats.distances[distKey].favProfit += runProfit;

                    if (isShortPriced) {
                        stats.tracks[race.meeting_name].shortBets++;
                        stats.tracks[race.meeting_name].shortProfit += runProfit;

                        stats.distances[distKey].shortBets++;
                        stats.distances[distKey].shortProfit += runProfit;
                    }
                });

                if (favWon) {
                    // Update Wins Count
                    // Note: If 2 favs and 1 wins, we have 2 runs, 1 win.
                    // But in the "Races" column of our table we usually count *Races*.
                    // The "Strike Rate" column is "Fav Wins / Races" or "Fav Wins / Fav Runs"?
                    // Current Implementation uses `stats.general[size].races` which counts RACES.
                    // If we want P&L, we must track 'runs' (bets) separately if we want true ROI.
                    // But for simplicity in the UI which shows "Races | Wins | SR", we are showing success rate per RACE.
                    // P&L however must be per STAKE.
                    // If there are 2 favs, we bet $2.
                    // So P&L is accurate to the bets.
                    // For the table display:
                    // we are showing "Races" (e.g. 500 races)
                    // "Wins" (e.g. 250 wins)
                    // "P&L": Sum of all profits.
                    // "ROI": P&L / (Number of Favourites Backed) ?? Or P&L / Races?
                    // Standard is ROI = Profit / Turnover.
                    // We need to track Turnover (total stakes) if we have multiple favs.
                    // Let's add 'bets' to the stats object to be precise.

                    stats.general[runnerCount].wins++;
                    stats.tracks[race.meeting_name].favWins++;
                    stats.distances[distKey].favWins++;
                    if (isShortPriced) {
                        stats.short[runnerCount].wins++;
                        stats.tracks[race.meeting_name].shortWins++;
                        stats.distances[distKey].shortWins++;
                    }
                }

                // Track Turnover for correct ROI calculation
                stats.general[runnerCount].bets += favourites.length;
                if (isShortPriced) stats.short[runnerCount].bets += favourites.length;

                stats.tracks[race.meeting_name].favBets += favourites.length;
                if (isShortPriced) stats.tracks[race.meeting_name].shortBets += favourites.length;

                stats.distances[distKey].favBets += favourites.length;
                if (isShortPriced) stats.distances[distKey].shortBets += favourites.length;
            });

            // --- HTML Generation Helpers ---
            const calcPct = (wins, total) => total > 0 ? ((wins / total) * 100).toFixed(1) + '%' : '-';
            const rateClass = (wins, total) => {
                if (total === 0) return 'text-zinc-500'; // Was zinc-600
                const pct = (wins / total) * 100;
                if (pct >= 50) return 'text-green-400 font-bold';
                if (pct >= 40) return 'text-green-300'; // Was green-200 (pastel), 300 is slightly more vibrant green
                if (pct >= 30) return 'text-zinc-300';
                return 'text-zinc-400'; // Was zinc-500
            };

            // 1. General & Short Tables
            const formatMoney = (val) => {
                const num = parseFloat(val);
                if (isNaN(num)) return '-';
                const sign = num >= 0 ? '+' : '-';
                return `${sign}$${Math.abs(num).toFixed(2)}`;
            };

            const formatROI = (profit, runs) => {
                if (runs === 0) return '-';
                const roi = (profit / runs) * 100;
                const sign = roi >= 0 ? '+' : '';
                // Color class
                let color = 'text-zinc-400';
                if (roi > 5) color = 'text-green-400 font-bold';
                else if (roi > 0) color = 'text-green-300';
                else if (roi < -10) color = 'text-red-400';

                return `<span class="${color}">${sign}${roi.toFixed(1)}%</span>`;
            };

            // Update Headers for sticky behavior
            const updateStickyHeaders = () => {
                const headers = [
                    document.querySelector('#statsFavGeneral').previousElementSibling.querySelector('th:first-child'),
                    document.querySelector('#statsFavShort').previousElementSibling.querySelector('th:first-child'),
                    document.querySelector('#statsBoxAll').previousElementSibling.querySelector('th:first-child'),
                    document.querySelector('#statsBoxShort').previousElementSibling.querySelector('th:first-child')
                ];
                headers.forEach(th => {
                    if (th) {
                        th.className = "px-4 py-3 text-left sticky left-0 z-10 bg-zinc-900 border-r border-zinc-800";
                        // Maintain original padding for Box stats which was px-2 py-2
                        if (th.textContent.trim() === 'Box') {
                            th.className = "px-2 py-2 text-left sticky left-0 z-10 bg-zinc-900 border-r border-zinc-800";
                        }
                    }
                });
            };
            updateStickyHeaders();

            const renderTableRows = (dataObj, targetId) => {
                const tbody = document.getElementById(targetId);
                if (!tbody) return;
                let html = '';
                let totalRaces = 0;
                let totalWins = 0;
                let totalProfit = 0;

                fieldSizes.forEach(size => {
                    const d = dataObj[size];
                    totalRaces += d.races;
                    totalWins += d.wins;
                    totalProfit += d.profit;

                    const moneyClass = d.profit >= 0 ? 'text-green-300' : 'text-red-300';
                    const stickyClass = "sticky left-0 bg-zinc-900 z-10 border-r border-zinc-800/50";

                    html += `
                        <tr class="hover:bg-white/5 transition relative">
                            <td class="px-4 py-3 font-medium text-white ${stickyClass}">${size} Runners</td>
                            <td class="px-4 py-3 text-center text-zinc-400">${d.races}</td>
                            <td class="px-4 py-3 text-center text-zinc-300">${d.wins}</td>
                            <td class="px-4 py-3 text-right ${rateClass(d.wins, d.races)}">${calcPct(d.wins, d.races)}</td>
                            <td class="px-4 py-3 text-right ${moneyClass} font-mono">${formatMoney(d.profit)}</td>
                            <td class="px-4 py-3 text-right font-mono">${formatROI(d.profit, d.races)}</td>
                        </tr>
                    `;
                });

                // Add Total Row
                const totalMoneyClass = totalProfit >= 0 ? 'text-green-300' : 'text-red-300';
                const stickyClass = "sticky left-0 bg-zinc-900 z-10 border-r border-zinc-800/50";

                html += `
                    <tr class="bg-zinc-800/50 font-bold border-t border-zinc-700 relative">
                        <td class="px-4 py-3 text-white ${stickyClass}">All Field Sizes</td>
                        <td class="px-4 py-3 text-center text-white">${totalRaces}</td>
                        <td class="px-4 py-3 text-center text-white">${totalWins}</td>
                        <td class="px-4 py-3 text-right ${rateClass(totalWins, totalRaces)}">${calcPct(totalWins, totalRaces)}</td>
                         <td class="px-4 py-3 text-right ${totalMoneyClass} font-mono">${formatMoney(totalProfit)}</td>
                        <td class="px-4 py-3 text-right font-mono">${formatROI(totalProfit, totalRaces)}</td>
                    </tr>
                `;

                tbody.innerHTML = html;
            };
            renderTableRows(stats.general, 'statsFavGeneral');
            renderTableRows(stats.short, 'statsFavShort');

            // 2. Box Matrix
            const renderBoxMatrix = (dataObj, targetId) => {
                const tbody = document.getElementById(targetId);
                if (!tbody) return;
                let html = '';
                for (let b = 1; b <= 8; b++) {
                    // Remove bg-zinc-900 so box colors (defined in CSS) show through
                    // Add min-width to ensure the sticky column has a consistent width
                    const stickyClass = "sticky left-0 z-10 border-r border-zinc-800/50";
                    let rowHtml = `<tr class="relative"><td class="px-2 py-2 font-bold box-${b} text-black w-8 text-center rounded-sm ${stickyClass}">${b}</td>`;

                    let totalRuns = 0;
                    let totalWins = 0;
                    let totalProfit = 0;

                    fieldSizes.forEach(size => {
                        const d = dataObj[size];
                        // dataObj[b][size] is technically wrong access pattern from previous code?
                        // Previous code corrected this to:
                        const boxData = dataObj[b][size];

                        totalRuns += boxData.runs;
                        totalWins += boxData.wins;
                        totalProfit += boxData.profit;

                        const pct = boxData.runs > 0 ? Math.round((boxData.wins / boxData.runs) * 100) : 0;
                        const cellContent = boxData.runs > 0
                            ? `<div class="flex flex-col items-center"><span class="text-xs font-bold ${pct >= 40 ? 'text-green-400' : 'text-zinc-200'}">${boxData.wins}/${boxData.runs}</span><span class="text-[9px] text-zinc-400">${pct}%</span></div>`
                            : '<span class="text-zinc-600">-</span>';
                        rowHtml += `<td class="px-2 py-2 border-l border-zinc-800/50 text-center">${cellContent}</td>`;
                    });

                    // Add Total Columns
                    const totalPct = totalRuns > 0 ? Math.round((totalWins / totalRuns) * 100) : 0;
                    const totalContent = totalRuns > 0
                        ? `<div class="flex flex-col items-center"><span class="text-xs font-bold ${totalPct >= 40 ? 'text-green-400' : 'text-zinc-200'}">${totalWins}/${totalRuns}</span><span class="text-[9px] text-zinc-400">${totalPct}%</span></div>`
                        : '<span class="text-zinc-600">-</span>';
                    rowHtml += `<td class="px-2 py-2 border-l border-zinc-700 text-center bg-zinc-800/30">${totalContent}</td>`;

                    // P&L
                    const plClass = totalProfit >= 0 ? 'text-green-300' : 'text-red-300';
                    rowHtml += `<td class="px-2 py-2 border-l border-zinc-700 text-right font-mono text-xs ${plClass}">${formatMoney(totalProfit)}</td>`;

                    // ROI
                    rowHtml += `<td class="px-2 py-2 text-right font-mono text-xs">${formatROI(totalProfit, totalRuns)}</td>`;

                    rowHtml += '</tr>';
                    html += rowHtml;
                }
                tbody.innerHTML = html;
            };
            renderBoxMatrix(stats.boxGeneral, 'statsBoxAll');
            renderBoxMatrix(stats.boxShort, 'statsBoxShort');

            // 3. Track Stats
            // Global sort state
            if (!window.trackSort) window.trackSort = { field: 'favRate', dir: 'desc' };

            const renderTrackTable = () => {
                const tracksBody = document.getElementById('statsTracks');
                if (!tracksBody) return;

                const sortedTracks = Object.entries(stats.tracks)
                    .map(([name, d]) => ({
                        name,
                        ...d,
                        favRate: d.races > 0 ? (d.favWins / d.races) * 100 : 0,
                        shortFavRate: d.shortRaces > 0 ? (d.shortWins / d.shortRaces) * 100 : 0,
                        top2in2Rate: d.races > 0 ? (d.top2in2 / d.races) * 100 : 0,
                        top2in2Rate4: d.races4 > 0 ? (d.top2in2_4 / d.races4) * 100 : 0,
                        box1FavRate: d.box1FavRuns > 0 ? (d.box1FavWins / d.box1FavRuns) * 100 : 0,
                        box1ShortFavRate: d.box1ShortFavRuns > 0 ? (d.box1ShortFavWins / d.box1ShortFavRuns) * 100 : 0,
                        // Add Sortable ROI fields
                        favROI: d.favBets > 0 ? (d.favProfit / d.favBets) * 100 : -999,
                        shortFavROI: d.shortBets > 0 ? (d.shortProfit / d.shortBets) * 100 : -999,
                        box1FavROI: d.box1FavRuns > 0 ? (d.box1FavProfit / d.box1FavRuns) * 100 : -999,
                        box1ShortFavROI: d.box1ShortFavRuns > 0 ? (d.box1ShortFavProfit / d.box1ShortFavRuns) * 100 : -999,
                        trackFavROI: d.favBets > 0 ? (d.favProfit / d.favBets) * 100 : -999
                    }))
                    .filter(t => t.races >= 1)
                    .sort((a, b) => {
                        const field = window.trackSort.field;
                        const dir = window.trackSort.dir === 'asc' ? 1 : -1;

                        if (field === 'name') return a.name.localeCompare(b.name) * dir;
                        return (a[field] - b[field]) * dir;
                    });

                // Helper for headers
                const sortIcon = (f) => window.trackSort.field === f ? (window.trackSort.dir === 'asc' ? ' ‚Üë' : ' ‚Üì') : '';
                const th = (label, field, center = true, sticky = false) => `
                    <th class="px-2 py-3 ${center ? 'text-center' : 'text-left'} cursor-pointer hover:text-white transition group ${sticky ? 'sticky left-0 z-10 bg-zinc-900 border-r border-zinc-800' : ''}" 
                        onclick="window.trackSort = { field: '${field}', dir: window.trackSort.field === '${field}' && window.trackSort.dir === 'desc' ? 'asc' : 'desc' }; renderStats();">
                        <div class="flex items-center ${center ? 'justify-center' : ''} gap-1">
                            ${label} <span class="text-[10px] opacity-30 group-hover:opacity-100">${sortIcon(field)}</span>
                        </div>
                    </th>`;

                // Header Header
                const table = document.getElementById('statsTracks').closest('table');
                const thead = table ? table.querySelector('thead tr') : null;
                if (thead) {
                    thead.innerHTML = `
                        ${th('Track', 'name', false, true)}
                        ${th('Races', 'races')}
                        ${th('Fav Wins', 'favWins')}
                        ${th('Fav SR%', 'favRate')}
                        ${th('Short Wins', 'shortWins')}
                        ${th('Short SR%', 'shortFavRate')}
                        ${th('T2inT2 %', 'top2in2Rate')}
                        ${th('4-Run Count', 'races4')}
                        ${th('Top2in2 (4)', 'top2in2Rate4')}
                        ${th('Box 1 Fav Wins', 'box1FavWins')}
                        ${th('Box 1 Fav %', 'box1FavRate')}
                        ${th('Box 1 Short Wins', 'box1ShortFavWins')}
                        ${th('Box 1 Short %', 'box1ShortFavRate')}
                        ${th('Track Fav ROI', 'trackFavROI')}
                        ${th('Short Fav ROI', 'shortFavROI')}
                        ${th('Box 1 Fav ROI', 'box1FavROI')}
                        ${th('Box 1 Short ROI', 'box1ShortFavROI')}
                    `;
                }

                tracksBody.innerHTML = sortedTracks.map(t => `
                    <tr class="hover:bg-white/5 transition border-b border-zinc-800/30 last:border-0 relative">
                        <td class="px-2 py-3 font-medium text-white truncate max-w-[120px] sticky left-0 bg-zinc-900 z-10 border-r border-zinc-800/50">${t.name}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.races}</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.favWins}</td>
                        <td class="px-2 py-3 text-center font-bold ${t.favRate >= 40 ? 'text-green-400' : 'text-zinc-400'}">${t.favRate.toFixed(1)}%</td>
                        
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.shortWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.shortRaces > 0 ? t.shortFavRate.toFixed(1) + '%' : '-'}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.top2in2Rate.toFixed(1)}%</td>
                        
                        <td class="px-2 py-3 text-center text-zinc-400">${t.races4}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.races4 > 0 ? t.top2in2Rate4.toFixed(1) + '%' : '-'}</td>
                        
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.box1FavWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.box1FavRuns > 0 ? t.box1FavRate.toFixed(1) + '%' : '-'}</td>
                        
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.box1ShortFavWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.box1ShortFavRuns > 0 ? t.box1ShortFavRate.toFixed(1) + '%' : '-'}</td>

                        <!-- Track Fav ROI -->
                        <td class="px-2 py-3 text-center font-mono text-xs">${formatROI(t.favProfit, t.favBets)}</td>

                        <!-- Short Fav ROI -->
                        <td class="px-2 py-3 text-center font-mono text-xs">${formatROI(t.shortProfit, t.shortBets)}</td>

                        <!-- Box 1 Fav ROI -->
                        <td class="px-2 py-3 text-center font-mono text-xs">${formatROI(t.box1FavProfit, t.box1FavRuns)}</td>

                        <!-- Box 1 Short Fav ROI -->
                        <td class="px-2 py-3 text-center font-mono text-xs">${formatROI(t.box1ShortFavProfit, t.box1ShortFavRuns)}</td>
                    </tr>
                `).join('');
            };
            renderTrackTable();

            // 4. Distance Stats Render
            // Global sort state for distance
            if (!window.distSort) window.distSort = { field: 'rawDist', dir: 'asc' }; // Default by Distance (Shortest first)

            const renderDistanceTable = () => {
                const tbody = document.getElementById('statsDistances');
                if (!tbody) return;

                const sortedDistances = Object.entries(stats.distances)
                    .map(([name, d]) => ({
                        name,
                        ...d,
                        favRate: d.races > 0 ? (d.favWins / d.races) * 100 : 0,
                        shortFavRate: d.shortRaces > 0 ? (d.shortWins / d.shortRaces) * 100 : 0,
                        top2in2Rate: d.races > 0 ? (d.top2in2 / d.races) * 100 : 0,
                        top2in2Rate4: d.races4 > 0 ? (d.top2in2_4 / d.races4) * 100 : 0,
                        box1FavRate: d.box1FavRuns > 0 ? (d.box1FavWins / d.box1FavRuns) * 100 : 0,
                        box1ShortFavRate: d.box1ShortFavRuns > 0 ? (d.box1ShortFavWins / d.box1ShortFavRuns) * 100 : 0,
                        favROI: d.favBets > 0 ? (d.favProfit / d.favBets) * 100 : -999,
                        shortFavROI: d.shortBets > 0 ? (d.shortProfit / d.shortBets) * 100 : -999,
                        box1FavROI: d.box1FavRuns > 0 ? (d.box1FavProfit / d.box1FavRuns) * 100 : -999,
                        box1ShortFavROI: d.box1ShortFavRuns > 0 ? (d.box1ShortFavProfit / d.box1ShortFavRuns) * 100 : -999
                    }))
                    .filter(t => t.races >= 1)
                    .sort((a, b) => {
                        const field = window.distSort.field;
                        const dir = window.distSort.dir === 'asc' ? 1 : -1;

                        if (field === 'name') return a.name.localeCompare(b.name) * dir;
                        return (a[field] - b[field]) * dir;
                    });

                // Helper for headers
                const sortIcon = (f) => window.distSort.field === f ? (window.distSort.dir === 'asc' ? ' ‚Üë' : ' ‚Üì') : '';
                const th = (label, field, center = true, sticky = false) => `
                    <th class="px-2 py-3 ${center ? 'text-center' : 'text-left'} cursor-pointer hover:text-white transition group ${sticky ? 'sticky left-0 z-10 bg-zinc-900 border-r border-zinc-800' : ''}" 
                        onclick="window.distSort = { field: '${field}', dir: window.distSort.field === '${field}' && window.distSort.dir === 'desc' ? 'asc' : 'desc' }; renderStats();">
                        <div class="flex items-center ${center ? 'justify-center' : ''} gap-1">
                            ${label} <span class="text-[10px] opacity-30 group-hover:opacity-100">${sortIcon(field)}</span>
                        </div>
                    </th>`;

                // Render Header
                const table = document.getElementById('statsDistances').closest('table');
                const thead = table ? table.querySelector('thead tr') : null;
                if (thead) {
                    thead.innerHTML = `
                        ${th('Distance', 'rawDist', true, true)}
                        ${th('Races', 'races')}
                        ${th('Fav Wins', 'favWins')}
                        ${th('Fav SR%', 'favRate')}
                        ${th('Short Wins', 'shortWins')}
                        ${th('Short SR%', 'shortFavRate')}
                        ${th('T2inT2 %', 'top2in2Rate')}
                        ${th('4-Run Count', 'races4')}
                        ${th('Top2in2 (4)', 'top2in2Rate4')}
                        ${th('Box 1 Fav Wins', 'box1FavWins')}
                        ${th('Box 1 Fav %', 'box1FavRate')}
                        ${th('Box 1 Short Wins', 'box1ShortFavWins')}
                        ${th('Box 1 Short %', 'box1ShortFavRate')}
                        ${th('Dist Fav ROI', 'favROI')}
                        ${th('Short Fav ROI', 'shortFavROI')}
                        ${th('Box 1 Fav ROI', 'box1FavROI')}
                        ${th('Box 1 Short ROI', 'box1ShortFavROI')}
                    `;
                }

                tbody.innerHTML = sortedDistances.map(t => `
                    <tr class="hover:bg-white/5 transition border-b border-zinc-800/30 last:border-0 relative">
                        <td class="px-2 py-3 font-medium text-white text-center sticky left-0 bg-zinc-900 z-10 border-r border-zinc-800/50">${t.name}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.races}</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.favWins}</td>
                        <td class="px-2 py-3 text-center font-bold ${t.favRate >= 40 ? 'text-green-400' : 'text-zinc-400'}">${t.favRate.toFixed(1)}%</td>
                        
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.shortWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.shortRaces > 0 ? t.shortFavRate.toFixed(1) + '%' : '-'}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.top2in2Rate.toFixed(1)}%</td>
                        
                        <td class="px-2 py-3 text-center text-zinc-400">${t.races4}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.races4 > 0 ? t.top2in2Rate4.toFixed(1) + '%' : '-'}</td>
                        
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.box1FavWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.box1FavRuns > 0 ? t.box1FavRate.toFixed(1) + '%' : '-'}</td>
                        
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.box1ShortFavWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.box1ShortFavRuns > 0 ? t.box1ShortFavRate.toFixed(1) + '%' : '-'}</td>

                        <!-- ROI Columns -->
                        <td class="px-2 py-3 text-center font-mono text-xs">${formatROI(t.favProfit, t.favBets)}</td>
                        <td class="px-2 py-3 text-center font-mono text-xs">${formatROI(t.shortProfit, t.shortBets)}</td>
                        <td class="px-2 py-3 text-center font-mono text-xs">${formatROI(t.box1FavProfit, t.box1FavRuns)}</td>
                        <td class="px-2 py-3 text-center font-mono text-xs">${formatROI(t.box1ShortFavProfit, t.box1ShortFavRuns)}</td>
                    </tr>
                `).join('');
            };
            renderDistanceTable();

        }
        function setStatsDateFilter(filter) {
            currentStatsDateFilter = filter;

            // Update UI
            const btns = {
                '3days': document.getElementById('btn3Days'),
                '7days': document.getElementById('btn7Days'),
                '90days': document.getElementById('btn90Days'),
                'all': document.getElementById('btnAllTime')
            };

            Object.keys(btns).forEach(key => {
                if (btns[key]) {
                    if (key === filter) {
                        btns[key].className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                    } else {
                        btns[key].className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";
                    }
                }
            });

            // Update Label
            const label = document.getElementById('filterContextLabel');
            if (label) {
                if (filter === '3days') label.textContent = 'Last 3 Days';
                else if (filter === '7days') label.textContent = 'Last 7 Days';
                else if (filter === '90days') label.textContent = 'Last 90 Days';
                else label.textContent = 'All Time';
            }

            // Re-render based on current view
            if (currentView === 'stats') {
                renderStats();
            } else if (currentView === 'history') {
                renderRaces();
            }
        }

        function toggleSmartFilter() {
            isSmartFilterActive = !isSmartFilterActive;
            const btn = document.getElementById('btnSmartFilter');
            if (isSmartFilterActive) {
                btn.className = "px-3 py-1 rounded-full text-xs font-bold bg-blue-600 text-white border border-blue-500 hover:bg-blue-500 transition flex items-center gap-1 shadow-[0_0_10px_rgba(37,99,235,0.5)]";
            } else {
                btn.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 border border-zinc-700 hover:bg-zinc-700 transition flex items-center gap-1";
            }
            renderRaces();
        }

        function populateTrackDropdown(races) {
            const select = document.getElementById('statsTrackFilter');
            if (!select) return;

            const currentSelection = select.value;

            // Get unique meeting names and sort
            const tracks = [...new Set(races.map(r => r.meeting_name))].sort();

            // Clear existing options except "All"
            select.innerHTML = '<option value="all">All Tracks</option>';

            tracks.forEach(track => {
                const option = document.createElement('option');
                option.value = track;
                option.textContent = track;
                if (track === currentSelection) {
                    option.selected = true;
                }
                select.appendChild(option);
            });

            // Restore selection validation
            if (currentSelection !== 'all' && !tracks.includes(currentSelection)) {
                currentStatsTrackFilter = 'all';
                select.value = 'all';
            }
        }

        function setStatsTrackFilter(val) {
            currentStatsTrackFilter = val;
            if (currentView === 'stats') renderStats();
            else renderRaces();
        }

        function setDateFilter(filter) {
            currentDateFilter = filter;
            // Update buttons
            const btnAll = document.getElementById('btnAll');
            const btnToday = document.getElementById('btnToday');
            const btnTomorrow = document.getElementById('btnTomorrow');

            if (btnAll && btnToday && btnTomorrow) {
                // Reset all buttons
                btnAll.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";
                btnToday.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";
                btnTomorrow.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";

                // Highlight selected button
                if (filter === 'all') {
                    btnAll.className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                } else if (filter === 'today') {
                    btnToday.className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                } else if (filter === 'tomorrow') {
                    btnTomorrow.className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                }
            }

            if (typeof renderRaces === 'function') {
                renderRaces();
            }
        }

        // --- Country Filter Logic ---
        function setStatsCountryFilter(val) {
            currentStatsCountryFilter = val;

            // Update Buttons
            const btnAll = document.getElementById('btnCountryAll');
            const btnAU = document.getElementById('btnCountryAU');
            const btnNZ = document.getElementById('btnCountryNZ');

            const activeClass = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
            const inactiveClass = "px-3 py-1 rounded-full text-xs font-bold text-zinc-400 hover:text-white transition";

            if (btnAll) btnAll.className = val === 'all' ? activeClass : inactiveClass;
            if (btnAU) btnAU.className = val === 'au' ? activeClass : inactiveClass;
            if (btnNZ) btnNZ.className = val === 'nz' ? activeClass : inactiveClass;

            if (currentView === 'stats') renderStats();
            else renderRaces();
        }

        // --- Multi-Select Track Filter Logic ---

        // --- Runners Filter Logic (Dropdown 2-8) ---
        let currentRunnersFilter = new Set(); // Empty = All

        function toggleRunnersFilterModal() {
            const modal = document.getElementById('runnersFilterModal');
            if (modal.classList.contains('hidden')) {
                populateRunnersFilterModal();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function populateRunnersFilterModal() {
            const container = document.getElementById('runnersListContainer');
            if (!container) return;
            container.innerHTML = '';

            const options = [2, 3, 4, 5, 6, 7, 8];
            const currentSelection = currentRunnersFilter.size === 0 ? new Set(options) : currentRunnersFilter;

            options.forEach(count => {
                const label = document.createElement('label');
                label.className = "flex items-center gap-2 p-1 hover:bg-zinc-800 rounded cursor-pointer text-[10px] text-zinc-300";

                const checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.value = count;
                checkbox.checked = currentSelection.has(count);
                checkbox.className = "accent-blue-600 rounded bg-zinc-700 border-zinc-600 w-3 h-3";

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(count + " Runners"));
                container.appendChild(label);
            });
            updateRunnersFilterCount();
        }

        function toggleAllRunners(select) {
            const checkboxes = document.querySelectorAll('#runnersListContainer input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = select);
        }

        function applyRunnersFilter() {
            const checkboxes = document.querySelectorAll('#runnersListContainer input[type="checkbox"]');
            const newSelection = new Set();
            let allUnchecked = true;

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    newSelection.add(parseInt(cb.value));
                    allUnchecked = false;
                }
            });

            if (allUnchecked) currentRunnersFilter.clear(); // Clear means All
            else currentRunnersFilter = newSelection;

            toggleRunnersFilterModal();
            updateRunnersFilterCount();
            if (currentView === 'stats') renderStats();
            else renderRaces();
        }

        function updateRunnersFilterCount() {
            const countSpan = document.getElementById('runnersFilterCount');
            const btn = document.getElementById('btnRunnersFilter');

            // If empty (All) or checks all options (2-8), treat as inactive
            const isAll = currentRunnersFilter.size === 0 || currentRunnersFilter.size === 7;

            if (!isAll) {
                countSpan.textContent = currentRunnersFilter.size;
                countSpan.classList.remove('hidden');
                btn.classList.add('bg-blue-900/40', 'border-blue-500/50', 'text-blue-200');
                btn.classList.remove('bg-zinc-800', 'text-zinc-300', 'border-zinc-700');
            } else {
                countSpan.classList.add('hidden');
                btn.classList.remove('bg-blue-900/40', 'border-blue-500/50', 'text-blue-200');
                btn.classList.add('bg-zinc-800', 'text-zinc-300', 'border-zinc-700');
            }
        }

        // --- Distance Filter Logic (Sprint/Short/Mid/Long) ---
        let currentDistanceFilter = new Set(); // Empty = All
        const DISTANCE_CATS = [
            { id: 'sprint', label: 'Sprint (<350m)', min: 0, max: 349 },
            { id: 'short', label: 'Short (350-449m)', min: 350, max: 449 },
            { id: 'mid', label: 'Mid (450-599m)', min: 450, max: 599 },
            { id: 'long', label: 'Long (600m+)', min: 600, max: 9999 }
        ];

        function toggleDistanceFilterModal() {
            const modal = document.getElementById('distanceFilterModal');
            if (modal.classList.contains('hidden')) {
                populateDistanceFilterModal();
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function populateDistanceFilterModal() {
            const container = document.getElementById('distanceListContainer');
            if (!container) return;
            container.innerHTML = '';

            const currentSelection = currentDistanceFilter.size === 0 ? new Set(DISTANCE_CATS.map(d => d.id)) : currentDistanceFilter;

            DISTANCE_CATS.forEach(cat => {
                const label = document.createElement('label');
                label.className = "flex items-center gap-2 p-1 hover:bg-zinc-800 rounded cursor-pointer text-[10px] text-zinc-300";

                const checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.value = cat.id;
                checkbox.checked = currentSelection.has(cat.id);
                checkbox.className = "accent-blue-600 rounded bg-zinc-700 border-zinc-600 w-3 h-3";

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(cat.label));
                container.appendChild(label);
            });
            updateDistanceFilterCount();
        }

        function toggleAllDistances(select) {
            const checkboxes = document.querySelectorAll('#distanceListContainer input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = select);
        }

        function applyDistanceFilter() {
            const checkboxes = document.querySelectorAll('#distanceListContainer input[type="checkbox"]');
            const newSelection = new Set();
            let allUnchecked = true;

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    newSelection.add(cb.value);
                    allUnchecked = false;
                }
            });

            if (allUnchecked) currentDistanceFilter.clear();
            else currentDistanceFilter = newSelection;

            toggleDistanceFilterModal();
            updateDistanceFilterCount();
            if (currentView === 'stats') renderStats();
            else renderRaces();
        }

        function updateDistanceFilterCount() {
            const countSpan = document.getElementById('distanceFilterCount');
            const btn = document.getElementById('btnDistanceFilter');
            const isAll = currentDistanceFilter.size === 0 || currentDistanceFilter.size === 4;

            if (!isAll) {
                countSpan.textContent = currentDistanceFilter.size;
                countSpan.classList.remove('hidden');
                btn.classList.add('bg-blue-900/40', 'border-blue-500/50', 'text-blue-200');
                btn.classList.remove('bg-zinc-800', 'text-zinc-300', 'border-zinc-700');
            } else {
                countSpan.classList.add('hidden');
                btn.classList.remove('bg-blue-900/40', 'border-blue-500/50', 'text-blue-200');
                btn.classList.add('bg-zinc-800', 'text-zinc-300', 'border-zinc-700');
            }
        }

        function toggleTrackFilterModal() {
            const modal = document.getElementById('trackFilterModal');
            modal.classList.toggle('hidden');
        }

        function populateTrackFilterModal(races) {
            const container = document.getElementById('trackListContainer');
            if (!container) return;

            // Get unique meeting names
            const tracks = [...new Set(races.map(r => r.meeting_name))].sort();

            // Save current selection to restore
            const currentSelection = new Set(currentStatsTrackFilter);

            container.innerHTML = '';

            tracks.forEach(track => {
                const isSelected = currentSelection.has(track);

                const label = document.createElement('label');
                label.className = "flex items-center gap-2 p-1.5 hover:bg-zinc-800 rounded cursor-pointer text-xs text-zinc-300";

                const checkbox = document.createElement('input');
                checkbox.type = "checkbox";
                checkbox.value = track;
                checkbox.checked = isSelected;
                checkbox.className = "accent-blue-600 rounded bg-zinc-700 border-zinc-600";

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(track));

                container.appendChild(label);
            });

            updateTrackFilterCount();
        }

        function toggleAllTracks(select) {
            const checkboxes = document.querySelectorAll('#trackListContainer input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = select);
        }

        function applyTrackFilter() {
            const checkboxes = document.querySelectorAll('#trackListContainer input[type="checkbox"]');
            const newSelection = new Set();
            let allUnchecked = true;

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    newSelection.add(cb.value);
                    allUnchecked = false;
                }
            });

            // If nothing checked, treat as "All" (empty set)
            if (allUnchecked) {
                currentStatsTrackFilter.clear();
            } else {
                currentStatsTrackFilter = newSelection;
            }

            toggleTrackFilterModal();
            updateTrackFilterCount();

            if (currentView === 'stats') renderStats();
            else renderRaces();
        }

        function updateTrackFilterCount() {
            const countSpan = document.getElementById('trackFilterCount');
            const size = currentStatsTrackFilter.size;
            if (size > 0) {
                countSpan.textContent = size;
                countSpan.classList.remove('hidden');
                document.getElementById('btnTrackFilter').classList.add('bg-blue-900/40', 'border-blue-500/50', 'text-blue-200');
                document.getElementById('btnTrackFilter').classList.remove('bg-zinc-800', 'text-zinc-300', 'border-zinc-700');
            } else {
                countSpan.classList.add('hidden');
                document.getElementById('btnTrackFilter').classList.remove('bg-blue-900/40', 'border-blue-500/50', 'text-blue-200');
                document.getElementById('btnTrackFilter').classList.add('bg-zinc-800', 'text-zinc-300', 'border-zinc-700');
            }
        }

        // Format countdown timer
        function formatCountdown(raceTime) {
            const now = new Date();
            const race = new Date(raceTime);
            const diff = race - now;

            if (diff < 0) {
                return 'FINISHED';
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Format race time
        function formatRaceTime(raceTime) {
            const date = new Date(raceTime);
            return date.toLocaleTimeString('en-AU', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Format date label (Top 2 Opp needs date only, Upcoming needs Today/Time)
        // User Request: History date format shorter (DD/MM/YY), no time for resulted.
        function formatDateLabel(raceTime, isResulted = false) {
            if (!raceTime) return '';
            const raceDate = new Date(raceTime);

            // Format: DD/MM/YY
            const day = raceDate.getDate().toString().padStart(2, '0');
            const month = (raceDate.getMonth() + 1).toString().padStart(2, '0');
            const yearStr = raceDate.getFullYear().toString().slice(-2);
            const shortDateStr = `${day}/${month}/${yearStr}`;

            // If resulted, just return date (no time)
            if (isResulted) {
                return shortDateStr;
            }

            // For upcoming/active, use Today/Tomorrow Logic
            const dateStr = raceDate.toLocaleDateString('en-CA');
            const now = new Date();
            const today = now.toLocaleDateString('en-CA');
            const tmr = new Date(now);
            tmr.setDate(tmr.getDate() + 1);
            const tomorrow = tmr.toLocaleDateString('en-CA');

            let label = shortDateStr;
            if (dateStr === today) {
                label = 'Today';
            } else if (dateStr === tomorrow) {
                label = 'Tomorrow';
            }

            // Append Time if not 00:00 (Midnight)
            const hours = raceDate.getHours();
            const minutes = raceDate.getMinutes();

            if (hours !== 0 || minutes !== 0) {
                const timeStr = raceDate.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: true });
                return `${label} ${timeStr}`;
            }

            return label;
        }

        // Check for Top 2 Opportunity (Blue)
        // For Upcoming: Uses Sportsbet Odds
        // For History: Uses Starting Price (SP) if available
        // Check for Top 2 Opportunity (Blue)
        // For Upcoming: Uses Sportsbet Odds
        // For History: Uses Starting Price (SP) if available
        function isRaceBlueOpp(race) {
            const isResulted = race.status === 'resulted' || (race.top_2_in_top_2 !== null);

            // Blue Opps are for fields of 5-8 runners
            if (race.active_runner_count < 5 || race.active_runner_count > 8) return false;

            const activeRunnersArr = (race.runners || []).filter(r => !r.is_scratched);

            // Choose odds source based on race status
            const getOdds = (r) => isResulted ? r.starting_price : r.sportsbet_odds;

            // Get valid odds and sort lowest to highest
            const runnersWithOdds = activeRunnersArr
                .filter(r => {
                    const odds = getOdds(r);
                    return odds !== null && odds > 0;
                })
                .sort((a, b) => getOdds(a) - getOdds(b));

            if (runnersWithOdds.length < 2) return false;

            const odds1 = getOdds(runnersWithOdds[0]);
            const odds2 = getOdds(runnersWithOdds[1]);
            // If there are more than 2 runners, check the rest. 
            const rest = runnersWithOdds.slice(2);

            // 5. Strict Logic: NO market leaders in Box 7 (Graveyard box)
            // Analysis (Jan 2026) shows Box 5 performs well (44% SR), so we UN-BAN Box 5.
            // Box 7 is still poor (~23%), so we keep it banned.
            // To implement this, we need to find the odds for Box 7.
            // This requires iterating through runnersWithOdds and finding the one with box_number 7.
            const box7Runner = runnersWithOdds.find(r => r.box_number === 7);
            const odds7 = box7Runner ? getOdds(box7Runner) : null;

            // If Box 7 exists and its odds are short (<= $4.00), it's a risk.
            // This is a negative filter, so if it's a risk, we return false immediately.
            if (odds7 !== null && odds7 <= 4.0) return false;

            // 6. Strategy 1: The "Sure Thing"
            // 1st Fav is < $2.00
            // AND we have a small field (<= 5 runners)
            // AND distance > 350m (Short races are volatile)
            const stratSureThingMatch = (odds1 < 2.00) &&
                (race.active_runner_count <= 5) &&
                (race.distance_meters > 350);
            if (stratSureThingMatch) return true;

            // --- Strategy 3: "Back the Red Plus" (Refined) ---
            // 1. 1st Fav is in Box 1 AND Odds < $2.50 (Strong Lead)
            // 2. 2nd Fav is also solid (< $3.50) to ensure we have a likely Top 2 pair.
            if (runnersWithOdds[0].box_number === 1 && odds1 < 2.50 && odds2 < 3.50) {
                return true;
            }
            // --- Strategy 1: The "Two Shorties" (Original) ---
            // 2 runners < $3.00
            // The rest >= $8.00
            const strat1Match = (odds1 < 3.00 && odds2 < 3.00) &&
                rest.every(r => getOdds(r) >= 8.00);

            if (strat1Match) return true;

            // --- Strategy 2: The "Dominant Fav + Gap" (New) ---
            // 1st Fav <= $1.60
            // 2nd available < $5.00
            // The rest >= $10.00
            const strat2Match = (odds1 <= 1.60 && odds2 < 5.00) &&
                rest.every(r => getOdds(r) >= 10.00);

            if (strat2Match) return true;

            return false;
        }

        // Format Money: Remove decimals if whole number (e.g. $61), else 2 decimals ($2.50)
        function formatMoney(val) {
            if (val === null || val === undefined) return '-';
            const num = parseFloat(val);
            if (isNaN(num)) return '-';
            if (num % 1 === 0) return `$${num.toFixed(0)}`;
            return `$${num.toFixed(2)}`;
        }

        // Create race card HTML
        function createRaceCard(race, runners, isBlueOpp = false) {
            const isMicroField = race.active_runner_count === 4;
            const isResulted = (race.status === 'resulted' || race.status === 'Resulted - No SPs') || (race.top_2_in_top_2 !== null);

            const cardClass = isMicroField ? 'micro-field-card' : 'opportunity-card';
            // Badge text is now just the runner count
            let badgeText = isMicroField ? '4 RUNNERS' : '5 RUNNERS';
            let badgeColor = isMicroField ? 'bg-red-900' : 'bg-orange-900';

            // Blue Opportunity Override (High Confidence)
            let finalCardClass = cardClass;
            if (isBlueOpp) {
                finalCardClass = 'bg-blue-900/40 border border-blue-500/30 hover:bg-blue-900/60 hover:border-blue-400/50 hover:shadow-blue-900/20';
                badgeText = `${race.active_runner_count} RUNNERS - TOP 2 OPP`;
                badgeColor = 'bg-blue-600';
            }

            // Sort logic
            let sortedRunners = [...runners];
            if (isResulted) {
                // Sort by finishing position (1, 2, 3...) then box
                sortedRunners.sort((a, b) => {
                    // Pull nulls/undefined to the bottom
                    const posA = a.finishing_position || 999;
                    const posB = b.finishing_position || 999;
                    if (posA !== posB) return posA - posB;
                    // Tie-breaker: box number
                    return a.box_number - b.box_number;
                });
            } else {
                // Default: Sort by box number
                sortedRunners.sort((a, b) => a.box_number - b.box_number);
            }

            const runnersHTML = sortedRunners.map(runner => {
                const scratchedClass = runner.is_scratched ? 'opacity-50 line-through' : '';
                const ghrOddsText = formatMoney(runner.ghr_odds);

                // For resulted races, show SP. For upcoming, show SB fixed odds.
                let secondOddsLabel = 'SB';
                let secondOddsText = formatMoney(runner.sportsbet_odds);
                let secondOddsClass = 'text-blue-300'; // Default SB blue

                if (isResulted) {
                    secondOddsLabel = 'SP';
                    secondOddsText = formatMoney(runner.starting_price);
                    secondOddsClass = 'text-yellow-300'; // SP in yellow/gold
                }

                const boxClass = `box-${runner.box_number}`;

                // Position Indicator (Gold/Silver/Bronze)
                let posIndicator = '';
                if (isResulted && runner.finishing_position) {
                    if (runner.finishing_position === 1) {
                        posIndicator = `<div class="w-4 text-center font-bold text-yellow-400 mr-1 text-[10px]">1st</div>`;
                    } else if (runner.finishing_position === 2) {
                        posIndicator = `<div class="w-4 text-center font-bold text-zinc-400 mr-1 text-[10px]">2nd</div>`;
                    } else if (runner.finishing_position === 3) {
                        posIndicator = `<div class="w-4 text-center font-bold text-amber-700 mr-1 text-[10px]">3rd</div>`;
                    } else {
                        // Spacer for non-placed runners to align boxes
                        posIndicator = `<div class="w-4 mr-1"></div>`;
                    }
                }

                return `
                    <div class="flex items-center justify-between py-0.5 border-b border-white/5 last:border-0 ${scratchedClass}">
                        <div class="flex items-center min-w-0">
                            ${posIndicator}
                            <div class="w-4 h-4 rounded-full ${boxClass} flex items-center justify-center font-bold text-[9px] flex-shrink-0 mr-1.5">
                                ${runner.box_number}
                            </div>
                            <div class="font-medium text-xs text-white/90 truncate pr-1">${runner.dog_name}</div>
                        </div>
                        <div class="flex gap-1.5 items-center flex-shrink-0">
                            <div class="text-right w-[28px]">
                                <div class="text-[8px] text-white/40 leading-none">GHR</div>
                                <div class="font-bold text-[10px] leading-tight">${ghrOddsText}</div>
                            </div>
                            <div class="text-right w-[28px]">
                                <div class="text-[8px] text-white/40 leading-none">${secondOddsLabel}</div>
                                <div class="font-bold text-[10px] leading-tight ${secondOddsClass}">${secondOddsText}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Resulted Label
            const resultedLabel = isResulted ?
                `<span class="ml-2 text-[10px] bg-green-900/80 text-green-300 px-1.5 py-0.5 rounded uppercase tracking-wider font-bold">Resulted</span>`
                : '';

            return `
                <div class="${finalCardClass} rounded-lg p-2 text-white transform transition hover:scale-[1.01] hover:shadow-lg">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-1.5 min-w-0 flex-1">
                            <div class="text-[9px] ${badgeColor} px-1.5 rounded-sm text-white/90 font-bold uppercase tracking-wider flex-shrink-0">
                                ${badgeText}
                            </div>
                            <h2 class="text-xs font-bold leading-tight truncate text-white/90">
                                ${race.meeting_name} ${race.race_number} ${race.distance_meters ? `<span class="opacity-60 font-normal ml-1">${race.distance_meters}m</span>` : ''}
                            </h2>
                        </div>
                        <div class="text-right pl-1 flex-shrink-0 flex items-center gap-2">
                            <div class="text-xs font-bold whitespace-nowrap opacity-75">
                                ${formatDateLabel(race.race_time, isResulted)}
                            </div>
                            ${resultedLabel}
                        </div>
                    </div>
                    
                    <div class="bg-black/20 rounded-md px-1.5 py-0.5 backdrop-blur-sm">
                        ${runnersHTML}
                    </div>
                </div>
            `;
        }

        // Update countdown timers
        function updateCountdowns() {
            const countdownElements = document.querySelectorAll('.countdown');
            countdownElements.forEach(elem => {
                const raceTime = elem.getAttribute('data-race-time');
                elem.textContent = formatCountdown(raceTime);
            });
        }

        // Render Races based on current view info
        function renderRaces() {
            const container = document.getElementById('racesContainer');
            if (!container) return;
            container.innerHTML = '';

            // Filter based on view
            // Use local date for "Today" comparison
            // To be safe, we use the device's local midnight
            // Reset to midnight for comparison by using local YYYY-MM-DD string
            const now = new Date();
            // toLocaleDateString('en-CA') returns "YYYY-MM-DD" in local time
            // This ensures "Today" matches even if UTC date is yesterday
            const todayStr = now.toLocaleDateString('en-CA');

            // Calculate tomorrow's date
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('en-CA');

            // Calculate history cutoff (if needed)
            let historyCutoffTime = 0;
            if (currentView === 'history' && currentStatsDateFilter !== 'all') {
                const cutoff = new Date();
                cutoff.setHours(0, 0, 0, 0);
                if (currentStatsDateFilter === '3days') cutoff.setDate(cutoff.getDate() - 3);
                else if (currentStatsDateFilter === '7days') cutoff.setDate(cutoff.getDate() - 7);
                else if (currentStatsDateFilter === '90days') cutoff.setDate(cutoff.getDate() - 90);
                historyCutoffTime = cutoff.getTime();
            }

            let displayRaces = cachedRaces.filter(race => {
                // race_time is ISO string
                if (!race.race_time) return false;

                // Convert UTC race time to local date string for comparison
                // OPTIMIZATION: Use pre-calculated dateStr
                const raceDateStr = race.dateStr || new Date(race.race_time).toLocaleDateString('en-CA');

                // Filter by view (upcoming vs history)
                let passesViewFilter = false;
                if (currentView === 'upcoming') {
                    passesViewFilter = raceDateStr >= todayStr;
                } else {
                    // History: Check strict cutoff (Last 7 Days, etc)
                    if (raceDateStr >= todayStr) return false;

                    // Apply Date Filter logic here for the List View too
                    if (currentStatsDateFilter !== 'all' && race.timestamp < historyCutoffTime) {
                        return false;
                    }
                    passesViewFilter = true;
                }

                if (!passesViewFilter) return false;

                // Check Blue Opportunity using shared logic
                const isBlueOpp = isRaceBlueOpp(race);
                race.isBlueOpp = isBlueOpp; // Tag for sort and card rendering

                // Filter by runner count (only show 4-5 runners OR Blue Opportunities)
                if (![4, 5].includes(race.active_runner_count) && !isBlueOpp) {
                    return false;
                }

                // Filter by Date (Today/Tomorrow/All) - ONLY applied in UPCOMING view
                if (currentView === 'upcoming' && currentDateFilter !== 'all') {
                    if (currentDateFilter === 'today') {
                        if (raceDateStr !== todayStr) return false;
                    } else if (currentDateFilter === 'tomorrow') {
                        if (raceDateStr !== tomorrowStr) return false;
                    }
                }

                // Smart Filter: Strict "Value Finder" üíé
                // --- GLOBAL FILTERS ---

                // 1. Country Filter
                if (currentStatsCountryFilter !== 'all') {
                    const isNZ = NZ_TRACKS.has(race.meeting_name);
                    const country = isNZ ? 'nz' : 'au';
                    if (country !== currentStatsCountryFilter) return false;
                }

                // 2. Track Filter (Multi-Select)
                if (currentStatsTrackFilter.size > 0) {
                    if (!currentStatsTrackFilter.has(race.meeting_name)) return false;
                }

                // 3. Runners Filter
                if (currentRunnersFilter.size > 0 && !currentRunnersFilter.has(race.active_runner_count)) return false;

                // 4. Distance Filter
                if (currentDistanceFilter.size > 0) {
                    const dist = race.distance_meters || 0;
                    let match = false;
                    // Check if dist falls into ANY selected category
                    for (const catId of currentDistanceFilter) {
                        const cat = DISTANCE_CATS.find(c => c.id === catId);
                        if (cat && dist >= cat.min && dist <= cat.max) {
                            match = true;
                            break;
                        }
                    }
                    if (!match) return false;
                }

                if (isSmartFilterActive) {
                    const activeRunners = (race.runners || []).filter(r => !r.is_scratched && r.sportsbet_odds > 0);
                    if (activeRunners.length < 2) return false; // Need at least 2 runners to have a "Top 2" market

                    // 1. Sort by Odds to find Market Leaders
                    activeRunners.sort((a, b) => a.sportsbet_odds - b.sportsbet_odds);

                    const fav1 = activeRunners[0];
                    const fav2 = activeRunners[1];

                    // Rule 1: Short Priced Favourite (< $2.00)
                    if (fav1.sportsbet_odds >= 2.00) return false;

                    // Rule 2: Small Field or Blue Opportunity
                    const isSmallField = race.active_runner_count <= 6;
                    if (!isSmallField && !isBlueOpp) return false;

                    // Rule 3: Distance >= 350m (Short sprints <350m had poor prediction rate)
                    // Handle null distance gracefully (assume valid if missing? No, strict.)
                    const dist = race.distance_meters || 0;
                    if (dist < 350) return false;

                    // Rule 4: "Dead Box" Avoidance (Strict)
                    // Neither the 1st nor 2nd Fav should be in Box 5 or Box 7
                    const badBoxes = [5, 7];
                    if (badBoxes.includes(fav1.box_number)) return false;
                    if (badBoxes.includes(fav2.box_number)) return false;
                }



                return true;
            });

            // Stats Calculation (Global based on cachedRaces, not just view)
            // We want to show stats for "Upcoming" races usually
            // But user asked for breakdown. Let's calculate based on ALL cached races that are Future or Today

            const statsRaces = cachedRaces.filter(race => {
                const rDate = race.dateStr; // OPTIMIZATION

                // Active Track Filter?
                if (currentStatsTrackFilter.size > 0 && !currentStatsTrackFilter.has(race.meeting_name)) {
                    return false;
                }

                // Country Filter
                if (currentStatsCountryFilter !== 'all') {
                    const isNZ = NZ_TRACKS.has(race.meeting_name);
                    const country = isNZ ? 'nz' : 'au';
                    if (country !== currentStatsCountryFilter) return false;
                }

                // 3. Runners Filter
                if (currentRunnersFilter.size > 0 && !currentRunnersFilter.has(race.active_runner_count)) return false;

                // 4. Distance Filter
                if (currentDistanceFilter.size > 0) {
                    const dist = race.distance_meters || 0;
                    let match = false;
                    for (const catId of currentDistanceFilter) {
                        const cat = DISTANCE_CATS.find(c => c.id === catId);
                        if (cat && dist >= cat.min && dist <= cat.max) {
                            match = true;
                            break;
                        }
                    }
                    if (!match) return false;
                }

                // Smart Filter (Value)
                if (isSmartFilterActive) {
                    const activeRunners = (race.runners || []).filter(r => !r.is_scratched && r.sportsbet_odds > 0);
                    if (activeRunners.length < 2) return false;

                    activeRunners.sort((a, b) => a.sportsbet_odds - b.sportsbet_odds);
                    const fav1 = activeRunners[0];
                    const fav2 = activeRunners[1];

                    if (fav1.sportsbet_odds >= 2.00) return false;

                    const isSmallField = race.active_runner_count <= 6;
                    const isBlueOpp = isRaceBlueOpp(race);
                    if (!isSmallField && !isBlueOpp) return false;

                    const dist = race.distance_meters || 0;
                    if (dist < 350) return false;

                    const badBoxes = [5, 7];
                    if (badBoxes.includes(fav1.box_number)) return false;
                    if (badBoxes.includes(fav2.box_number)) return false;
                }

                return rDate >= todayStr; // Only count Today & Future for the dashboard
            });

            function countStats(runnerCount) {
                const total = statsRaces.filter(r => r.active_runner_count === runnerCount).length;
                const todayCount = statsRaces.filter(r => r.active_runner_count === runnerCount && r.dateStr === todayStr).length;
                // Anything > todayStr is tomorrow+
                const tomorrowCount = statsRaces.filter(r => r.active_runner_count === runnerCount && r.dateStr > todayStr).length;
                return { total, todayCount, tomorrowCount };
            }

            function countBlueStats() {
                const blueRaces = statsRaces.filter(r => isRaceBlueOpp(r));
                const total = blueRaces.length;
                const todayCount = blueRaces.filter(r => r.dateStr === todayStr).length;
                const tomorrowCount = blueRaces.filter(r => r.dateStr > todayStr).length;
                return { total, todayCount, tomorrowCount };
            }

            const stats4 = countStats(4);
            const stats5 = countStats(5);
            const statsBlue = countBlueStats();

            // Safe update of DOM elements
            const safeSetText = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };

            safeSetText('stats4Total', stats4.total);
            safeSetText('stats4Today', stats4.todayCount);
            safeSetText('stats4Tomorrow', stats4.tomorrowCount);

            safeSetText('stats5Total', stats5.total);
            safeSetText('stats5Today', stats5.todayCount);
            safeSetText('stats5Tomorrow', stats5.tomorrowCount);

            safeSetText('statsBlueTotal', statsBlue.total);
            safeSetText('statsBlueToday', statsBlue.todayCount);
            safeSetText('statsBlueTomorrow', statsBlue.tomorrowCount);


            // Handle empty state
            document.getElementById('noRacesState').classList.add('hidden');
            if (displayRaces.length === 0) {
                document.getElementById('noRacesState').classList.remove('hidden');
                return; // Nothing else to do
            }





            document.getElementById('statsBlueTotal').textContent = statsBlue.total;
            document.getElementById('statsBlueToday').textContent = statsBlue.todayCount;
            document.getElementById('statsBlueTomorrow').textContent = statsBlue.tomorrowCount;

            // History Stats - Top 2 in Top 2 Strike Rates
            if (currentView === 'history') {
                const getStatsCutoff = () => {
                    if (currentStatsDateFilter === 'all') return null;
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    if (currentStatsDateFilter === '3days') now.setDate(now.getDate() - 3);
                    else if (currentStatsDateFilter === '7days') now.setDate(now.getDate() - 7);
                    else if (currentStatsDateFilter === '90days') now.setDate(now.getDate() - 90);
                    return now;
                };
                const cutoffDate = getStatsCutoff();

                const historyRaces = cachedRaces.filter(race => {
                    const rDate = new Date(race.race_time); // Keep this for cutoff comparison
                    const rDateStr = race.dateStr; // OPTIMIZATION: Use pre-calc for string compare

                    // Basic History Check (Before Today)
                    if (rDateStr >= todayStr) return false;

                    // Apply Date Filter
                    if (cutoffDate && rDate < cutoffDate) return false;

                    // Only historical races with results
                    if (race.top_2_in_top_2 === null) return false;

                    // Apply Track Filter (Multi-Select)
                    if (currentStatsTrackFilter.size > 0 && !currentStatsTrackFilter.has(race.meeting_name)) {
                        return false;
                    }

                    // Apply Country Filter
                    if (currentStatsCountryFilter !== 'all') {
                        const isNZ = NZ_TRACKS.has(race.meeting_name);
                        const country = isNZ ? 'nz' : 'au';
                        if (country !== currentStatsCountryFilter) return false;
                    }

                    return true;
                });

                function calculateStrikeRate(runnerCount) {
                    const races = historyRaces.filter(r => r.active_runner_count === runnerCount);
                    const total = races.length;
                    const successes = races.filter(r => r.top_2_in_top_2 === true).length;
                    const percentage = total > 0 ? ((successes / total) * 100).toFixed(1) : 0;
                    return { successes, total, percentage };
                }

                const history4 = calculateStrikeRate(4);
                const history5 = calculateStrikeRate(5);
                const history6 = calculateStrikeRate(6);
                const history7 = calculateStrikeRate(7);
                const history8 = calculateStrikeRate(8);

                // Calculate Blue Opps Strike Rate
                // Reuse logic but filter by isRaceBlueOpp
                // Note: calculateStrikeRate above filters by runner count. We need a custom filter.
                const blueHistoryRaces = historyRaces.filter(r => isRaceBlueOpp(r));
                const blueTotal = blueHistoryRaces.length;
                const blueSuccesses = blueHistoryRaces.filter(r => r.top_2_in_top_2 === true).length;
                const bluePercentage = blueTotal > 0 ? ((blueSuccesses / blueTotal) * 100).toFixed(1) : 0;

                // All fields combined
                const allTotal = historyRaces.length;
                const allSuccesses = historyRaces.filter(r => r.top_2_in_top_2 === true).length;
                const allPercentage = allTotal > 0 ? ((allSuccesses / allTotal) * 100).toFixed(1) : 0;

                // Update DOM
                document.getElementById('statsHistory4').textContent = `${history4.successes}/${history4.total}`;
                document.getElementById('statsHistory4Pct').textContent = `${history4.percentage}%`;

                document.getElementById('statsHistory5').textContent = `${history5.successes}/${history5.total}`;
                document.getElementById('statsHistory5Pct').textContent = `${history5.percentage}%`;

                document.getElementById('statsHistory6').textContent = `${history6.successes}/${history6.total}`;
                document.getElementById('statsHistory6Pct').textContent = `${history6.percentage}%`;

                document.getElementById('statsHistory7').textContent = `${history7.successes}/${history7.total}`;
                document.getElementById('statsHistory7Pct').textContent = `${history7.percentage}%`;

                document.getElementById('statsHistory8').textContent = `${history8.successes}/${history8.total}`;
                document.getElementById('statsHistory8Pct').textContent = `${history8.percentage}%`;

                document.getElementById('statsHistoryBlue').textContent = `${blueSuccesses}/${blueTotal}`;
                document.getElementById('statsHistoryBluePct').textContent = `${bluePercentage}%`;

                document.getElementById('statsHistoryAll').textContent = `${allSuccesses}/${allTotal}`;
                document.getElementById('statsHistoryAllPct').textContent = `${allPercentage}%`;
            }

            // Handle empty state for list
            document.getElementById('noRacesState').classList.add('hidden');
            if (displayRaces.length === 0) {
                document.getElementById('noRacesState').classList.remove('hidden');
                return;
            }

            // Sort logic: Micro-Fields (4) FIRST, then 5s, then Blue Opps (by virtue of being >5)
            // But we filter list to [4, 5, BlueOpps]
            // If we sort by active_runner_count, we get 4, 5, 6/7/8.
            // This satisfies the requirement: "Blue Opps... last on the sorting after 4 runners and 5 runners"
            // Sort logic: Date > Category (4 > 5 > Top 2 Opp) > Meeting
            const sortedRaces = displayRaces.sort((a, b) => {
                // Priority 1: 4 Runners Pinned to Top
                const isA4 = a.active_runner_count === 4;
                const isB4 = b.active_runner_count === 4;
                if (isA4 && !isB4) return -1;
                if (!isA4 && isB4) return 1;

                // Priority 2: Date
                if (a.dateStr !== b.dateStr) return a.dateStr.localeCompare(b.dateStr);

                // Priority 3: Category
                // Rank: 5 Runners (1) < Top 2 Opps (2)
                const getRank = (r) => {
                    if (r.active_runner_count === 4) return 0;
                    if (r.isBlueOpp) return 2;
                    return 1;
                };

                const rankA = getRank(a);
                const rankB = getRank(b);
                if (rankA !== rankB) return rankA - rankB;

                // Priority 3: Meeting
                if (a.meeting_name !== b.meeting_name) return a.meeting_name.localeCompare(b.meeting_name);

                // Priority 4: Race Number
                return a.race_number - b.race_number;
            });

            // Add cards (Batched DOM update for performance)
            const cardsHTML = sortedRaces.map(race => {
                const raceRunners = (race.runners || []).sort((a, b) => a.box_number - b.box_number);
                return createRaceCard(race, raceRunners, race.isBlueOpp);
            }).join('');

            container.innerHTML = cardsHTML;
        }

        // Fetch Races from Supabase
        async function fetchRaces() {
            if (!supabaseClient) return; // Don't try if initialization failed
            console.log('Fetching races...');
            try {
                // Show loading state only if no cache
                const loading = document.getElementById('loadingState');
                if (cachedRaces.length === 0) loading.classList.remove('hidden');

                document.getElementById('errorState').classList.add('hidden');

                // Query races with their runners
                // Fetch all races (not just 4-5) so we can show strike rates for all runner counts in History
                // FIX: Use Newest First (desc) - Limit removed per user request
                const { data: races, error: racesError } = await supabaseClient
                    .from('races')
                    .select('*, runners(*)')  // Optimized join
                    .order('race_time', { ascending: false });

                if (racesError) throw racesError;

                // PERFORMANCE OPTIMIZATION: Pre-calculate date strings and timestamps
                // This prevents creating new Date() objects thousands of times during sorting/filtering
                races.forEach(r => {
                    const d = new Date(r.race_time);
                    r.timestamp = d.getTime(); // For fast numeric sort
                    // Use local date for "Today" grouping
                    r.dateStr = d.toLocaleDateString('en-CA');
                });

                // Update cache
                cachedRaces = races || [];

                // DATA DEBUGGING
                console.log(`Fetched ${cachedRaces.length} races.`);
                if (cachedRaces.length > 0) {
                    const sample = cachedRaces[0];
                    console.log('Sample Race:', sample);
                    console.log('Sample Runners:', sample.runners);

                    // Check for runners == null issues
                    const badRaces = cachedRaces.filter(r => !r.runners || r.runners.length === 0);
                    if (badRaces.length > 0) {
                        console.warn(`WARNING: ${badRaces.length} races have NO runners attached!`);
                        console.log('Bad Race Example:', badRaces[0]);
                    }
                }

                populateTrackFilterModal(cachedRaces);

                // Hide loading state
                loading.classList.add('hidden');

                // Render with current view
                renderRaces();

                // Update last updated time
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('en-AU');

                // Start countdown timer
                clearInterval(window.countdownInterval);
                window.countdownInterval = setInterval(updateCountdowns, 1000);

            } catch (error) {
                console.error('Error loading races:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchRaces();

            // Refresh data every 2 minutes
            setInterval(fetchRaces, 2 * 60 * 1000);
        });
    </script>

</body>

</html>