<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4 Mutt Finder</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0a0a;
        }

        .micro-field-card {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
            animation: pulse-red 2s ease-in-out infinite;
        }

        .opportunity-card {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3);
            animation: pulse-orange 2s ease-in-out infinite;
        }

        @keyframes pulse-red {

            0%,
            100% {
                box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
            }

            50% {
                box-shadow: 0 15px 40px rgba(239, 68, 68, 0.6);
            }
        }

        @keyframes pulse-orange {

            0%,
            100% {
                box-shadow: 0 10px 30px rgba(249, 115, 22, 0.3);
            }

            50% {
                box-shadow: 0 15px 40px rgba(249, 115, 22, 0.5);
            }
        }

        .countdown {
            font-variant-numeric: tabular-nums;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Standard greyhound box colors */
        /* Standard Australian Greyhound Box Colors */
        .box-1 {
            background: #ef4444;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .box-2 {
            background: repeating-linear-gradient(180deg,
                    #000000,
                    #000000 5px,
                    #ffffff 5px,
                    #ffffff 10px);
            color: #ef4444 !important;
            /* Force Red */
            font-weight: 900;
            text-shadow: 0 0 2px #ffffff, 0 0 4px #ffffff;
        }

        .box-3 {
            background: #ffffff;
            color: #000000;
        }

        .box-4 {
            background: #2563eb;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .box-5 {
            background: #eab308;
            color: #000000;
        }

        .box-6 {
            background: #16a34a;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .box-7 {
            background: #000000;
            color: #ffffff !important;
            /* Force White */
            font-weight: bold;
        }

        .box-8 {
            background: #ec4899;
            color: black;
        }

        .box-9 {
            background: repeating-linear-gradient(45deg,
                    #16a34a,
                    #16a34a 5px,
                    #ffffff 5px,
                    #ffffff 10px);
            color: #000000;
            text-shadow: 0 0 2px #fff;
        }

        .box-10 {
            background: linear-gradient(to right, #ef4444 33%, #ffffff 33%, #ffffff 66%, #2563eb 66%);
            color: #000000;
            text-shadow: 0 0 2px #fff;
        }

        /* Responsive grid */
        @media (min-width: 768px) {
            .races-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
    </style>
</head>

<body class="min-h-screen text-white">

    <!-- Header -->
    <header class="bg-zinc-900/90 backdrop-blur-lg border-b border-zinc-800 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-base md:text-xl font-bold text-center">
                üêï 4 Mutt Finder
            </h1>
            <p class="text-center text-zinc-500 text-xs mt-1">
                Live tracking of 4 & 5 runners
            </p>


            <!-- View Toggles -->
            <div class="flex justify-center gap-2 mt-4">
                <button id="btnUpcoming" onclick="setView('upcoming')"
                    class="px-4 py-1.5 rounded-full text-sm font-bold bg-white text-black transition">
                    Upcoming
                </button>
                <button id="btnHistory" onclick="setView('history')"
                    class="px-4 py-1.5 rounded-full text-sm font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">
                    History
                </button>
                <button id="btnStats" onclick="setView('stats')"
                    class="px-4 py-1.5 rounded-full text-sm font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">
                    Stats
                </button>
            </div>

            <!-- Date Filter & Distance Filter (only visible in Upcoming view) -->
            <div id="filtersContainer" class="flex flex-wrap justify-center gap-2 mt-3">
                <div id="dateFilter" class="flex gap-2">
                    <button id="btnAll" onclick="setDateFilter('all')"
                        class="px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition">
                        All
                    </button>
                    <button id="btnToday" onclick="setDateFilter('today')"
                        class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">
                        Today
                    </button>
                    <button id="btnTomorrow" onclick="setDateFilter('tomorrow')"
                        class="px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition">
                        Tomorrow
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">

        <!-- Stats Bar -->
        <div id="statsUpcoming" class="grid grid-cols-3 gap-2 mb-3">
            <!-- 4 Runners -->
            <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-[10px] font-bold text-zinc-400 uppercase">4 Runners</div>
                    <div class="text-xl font-bold text-red-500" id="stats4Total">-</div>
                </div>
                <div class="flex justify-between text-[10px] text-zinc-500 border-t border-zinc-800 pt-1">
                    <div>Today: <span id="stats4Today" class="text-white font-bold ml-1">-</span></div>
                    <div>Tmr: <span id="stats4Tomorrow" class="text-white font-bold ml-1">-</span></div>
                </div>
            </div>
            <!-- 5 Runners -->
            <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-[10px] font-bold text-zinc-400 uppercase">5 Runners</div>
                    <div class="text-xl font-bold text-orange-500" id="stats5Total">-</div>
                </div>
                <div class="flex justify-between text-[10px] text-zinc-500 border-t border-zinc-800 pt-1">
                    <div>Today: <span id="stats5Today" class="text-white font-bold ml-1">-</span></div>
                    <div>Tmr: <span id="stats5Tomorrow" class="text-white font-bold ml-1">-</span></div>
                </div>
            </div>
            <!-- Blue Opps -->
            <div class="bg-blue-900/20 backdrop-blur-lg rounded-lg p-2 border border-blue-800/50">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-[10px] font-bold text-blue-300 uppercase">Top 2 Opps</div>
                    <div class="text-xl font-bold text-blue-400" id="statsBlueTotal">-</div>
                </div>
                <div class="flex justify-between text-[10px] text-zinc-500 border-t border-blue-800/30 pt-1">
                    <div>Today: <span id="statsBlueToday" class="text-white font-bold ml-1">-</span></div>
                    <div>Tmr: <span id="statsBlueTomorrow" class="text-white font-bold ml-1">-</span></div>
                </div>
            </div>
        </div>

        <!-- Stats Bar for History View (Top 2 in Top 2 Strike Rates) -->
        <div id="statsHistory" class="hidden mb-3">
            <!-- Top Row: 4 & 5 Runners (Larger) -->
            <div class="grid grid-cols-2 gap-2 mb-2">
                <!-- 4 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-3 border border-zinc-800">
                    <div class="text-xs font-bold text-zinc-400 uppercase mb-2">4 Runners</div>
                    <div class="text-2xl font-bold text-red-500" id="statsHistory4">-</div>
                    <div class="text-xs text-zinc-300 mt-1" id="statsHistory4Pct">-</div>
                    <div class="text-[9px] text-zinc-400 uppercase mt-0.5 tracking-wide">Top 2 in Top 2 Strike Rate
                    </div>
                </div>
                <!-- 5 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-3 border border-zinc-800">
                    <div class="text-xs font-bold text-zinc-400 uppercase mb-2">5 Runners</div>
                    <div class="text-2xl font-bold text-orange-500" id="statsHistory5">-</div>
                    <div class="text-xs text-zinc-300 mt-1" id="statsHistory5Pct">-</div>
                    <div class="text-[9px] text-zinc-400 uppercase mt-0.5 tracking-wide">Top 2 in Top 2 Strike Rate
                    </div>
                </div>
            </div>

            <!-- Bottom Row: 6, 7, 8, All (Smaller) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <!-- 6 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">6 Runners</div>
                    <div class="text-sm font-bold text-yellow-500" id="statsHistory6">-</div>
                    <div class="text-[8px] text-zinc-300" id="statsHistory6Pct">-</div>
                </div>
                <!-- 7 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">7 Runners</div>
                    <div class="text-sm font-bold text-green-500" id="statsHistory7">-</div>
                    <div class="text-[8px] text-zinc-300" id="statsHistory7Pct">-</div>
                </div>
                <!-- 8 Runners -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">8 Runners</div>
                    <div class="text-sm font-bold text-blue-500" id="statsHistory8">-</div>
                    <div class="text-[8px] text-zinc-300" id="statsHistory8Pct">-</div>
                </div>
                <!-- All Fields -->
                <div class="bg-zinc-900/50 backdrop-blur-lg rounded-lg p-2 border border-zinc-800">
                    <div class="text-[9px] font-bold text-zinc-400 uppercase mb-1">All Fields</div>
                    <div class="text-sm font-bold text-white" id="statsHistoryAll">-</div>
                    <div class="text-[8px] text-zinc-300" id="statsHistoryAllPct">-</div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="flex flex-col items-center justify-center py-20">
            <div class="loading-spinner mb-4"></div>
            <p class="text-zinc-400">Loading races...</p>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden bg-red-900/30 border border-red-700 rounded-xl p-6 text-center">
            <p class="text-red-400 font-semibold">‚ö†Ô∏è Error loading races</p>
            <p class="text-zinc-400 text-sm mt-2" id="errorMessage"></p>
            <button onclick="loadRaces()" class="mt-4 px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                Retry
            </button>
        </div>

        <!-- No Races State -->
        <div id="noRacesState"
            class="hidden bg-zinc-900/50 backdrop-blur-lg rounded-xl p-8 text-center border border-zinc-800">
            <p class="text-2xl mb-2">üéØ</p>
            <p class="text-zinc-300 font-semibold">No micro-fields found</p>
            <p class="text-zinc-400 text-sm mt-2">Check back soon for 4-5 runner races</p>
        </div>

        <!-- Races Container -->
        <!-- Races Container -->
        <div id="racesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            <!-- Race cards will be inserted here -->
        </div>
        <!-- Race cards will be inserted here -->
        </div>

        <!-- Stats View -->
        <div id="statsView" class="hidden space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 1. General Favourites Stats -->
                <section>
                    <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                        <span>üèÜ</span> Favourites Strike Rate
                    </h3>
                    <div class="overflow-x-auto rounded-lg border border-zinc-800">
                        <table class="w-full text-sm text-left text-zinc-400">
                            <thead class="text-xs text-zinc-200 uppercase bg-zinc-900/50">
                                <tr>
                                    <th class="px-4 py-3">Field Size</th>
                                    <th class="px-4 py-3 text-center">Races</th>
                                    <th class="px-4 py-3 text-center">Fav Wins</th>
                                    <th class="px-4 py-3 text-right">Strike Rate</th>
                                </tr>
                            </thead>
                            <tbody id="statsFavGeneral" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                                <!-- Populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- 2. Short Priced Favourites (< $2.00) -->
                <section>
                    <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                        <span>üî•</span> Short Priced Favourites (< $2.00) </h3>
                            <div class="overflow-x-auto rounded-lg border border-zinc-800">
                                <table class="w-full text-sm text-left text-zinc-400">
                                    <thead class="text-xs text-zinc-200 uppercase bg-zinc-900/50">
                                        <tr>
                                            <th class="px-4 py-3">Field Size</th>
                                            <th class="px-4 py-3 text-center">Races</th>
                                            <th class="px-4 py-3 text-center">Short Fav Wins</th>
                                            <th class="px-4 py-3 text-right">Strike Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody id="statsFavShort" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                                        <!-- Populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                </section>
            </div>

            <!-- 3. Favourites by Box Number -->
            <section>
                <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                    <span>üì¶</span> Favourites by Box
                </h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- All Favs -->
                    <div>
                        <h4 class="text-sm font-bold text-zinc-400 mb-2 uppercase tracking-wide">All Favourites</h4>
                        <div class="overflow-x-auto rounded-lg border border-zinc-800">
                            <table class="w-full text-xs text-center text-zinc-400">
                                <thead class="text-zinc-200 bg-zinc-900/50 uppercase">
                                    <tr>
                                        <th class="px-2 py-2 text-left">Box</th>
                                        <th class="px-2 py-2">4 Runners</th>
                                        <th class="px-2 py-2">5 Runners</th>
                                        <th class="px-2 py-2">6 Runners</th>
                                        <th class="px-2 py-2">7 Runners</th>
                                        <th class="px-2 py-2">8 Runners</th>
                                        <th class="px-2 py-2 text-white font-bold border-l border-zinc-700">All</th>
                                    </tr>
                                </thead>
                                <tbody id="statsBoxAll" class="bg-zinc-900/20 divide-y divide-zinc-800/50"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Short Favs -->
                    <div>
                        <h4 class="text-sm font-bold text-zinc-400 mb-2 uppercase tracking-wide">Short Priced (<
                                $2.00)</h4>
                                <div class="overflow-x-auto rounded-lg border border-zinc-800">
                                    <table class="w-full text-xs text-center text-zinc-400">
                                        <thead class="text-zinc-200 bg-zinc-900/50 uppercase">
                                            <tr>
                                                <th class="px-2 py-2 text-left">Box</th>
                                                <th class="px-2 py-2">4 Runners</th>
                                                <th class="px-2 py-2">5 Runners</th>
                                                <th class="px-2 py-2">6 Runners</th>
                                                <th class="px-2 py-2">7 Runners</th>
                                                <th class="px-2 py-2">8 Runners</th>
                                                <th class="px-2 py-2 text-white font-bold border-l border-zinc-700">All
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="statsBoxShort" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                                        </tbody>
                                    </table>
                                </div>
                    </div>
                </div>
            </section>

            <!-- 4. Track Stats -->
            <section>
                <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                    <span>üìç</span> Track Performance
                </h3>
                <div class="overflow-x-auto rounded-lg border border-zinc-800">
                    <table class="w-full text-sm text-left text-zinc-400">
                        <thead class="text-xs text-zinc-200 uppercase bg-zinc-900/50">
                            <tr>
                                <th class="px-4 py-3">Track</th>
                                <th class="px-4 py-3 text-center">Races</th>
                                <th class="px-4 py-3 text-center">Fav Wins</th>
                                <th class="px-4 py-3 text-center">Fav SR%</th>
                                <th class="px-4 py-3 text-center">Short Fav Wins</th>
                                <th class="px-4 py-3 text-center">Short Fav SR%</th>
                            </tr>
                        </thead>
                        <tbody id="statsTracks" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 5. Distance Stats -->
            <section class="mt-6">
                <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                    <span>üìè</span> Distance Performance
                </h3>
                <div class="overflow-x-auto rounded-lg border border-zinc-800">
                    <table class="w-full text-sm text-left text-zinc-400">
                        <thead class="text-xs text-zinc-200 uppercase bg-zinc-900/50">
                            <tr>
                                <!-- JS renders headers -->
                            </tr>
                        </thead>
                        <tbody id="statsDistances" class="bg-zinc-900/20 divide-y divide-zinc-800/50">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

        </div>

        <!-- Last Updated -->
        <div class="text-center text-zinc-600 text-sm mt-8">
            Last updated: <span id="lastUpdated">-</span>
        </div>

    </main>

    <!-- Footer -->
    <footer class="text-center text-zinc-600 text-sm py-6 mt-12">
        <p>Data sourced from The Greyhound Recorder</p>
        <p class="mt-1">Updates every 15 minutes</p>
    </footer>

    <script>
        // Configuration - Supabase credentials
        const SUPABASE_URL = 'https://yvnkyakuamvahtiwbneq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2bmt5YWt1YW12YWh0aXdibmVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5Mzg4MTQsImV4cCI6MjA4NDUxNDgxNH0.-v9LyyRgX2tj9EFCImHo44XxSQcZ4_GmQZw-q7ZTX5I';

        // Initialize Supabase client
        let supabaseClient;
        try {
            if (!window.supabase) throw new Error('Supabase library not loaded. Check connection.');
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.error(e);
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = 'Failed to initialize app: ' + e.message;
        }

        // Safety timeout - if nothing happens in 10s, verify what's wrong
        setTimeout(() => {
            const loading = document.getElementById('loadingState');
            if (!loading.classList.contains('hidden')) {
                // If still loading after 10s, show error or console status
                console.warn('Loading timeout reached');
                loading.innerHTML = `
                    <div class="loading-spinner mb-4"></div>
                    <p class="text-zinc-400">Still loading... (Slow connection?)</p>
                    <p class="text-zinc-600 text-xs mt-2">Check console for errors</p>
                `;
            }
        }, 8000);

        // State
        let countdownIntervals = [];
        let cachedRaces = [];
        let currentView = 'upcoming'; // 'upcoming' or 'history'
        let currentDateFilter = 'all'; // 'all', 'today', or 'tomorrow'
        let currentDistanceFilter = 'all'; // 'all', 'short', 'medium', 'long'

        // Set View mode
        function setView(mode) {
            currentView = mode;
            // Update buttons
            const btnUpcoming = document.getElementById('btnUpcoming');
            const btnHistory = document.getElementById('btnHistory');
            const btnStats = document.getElementById('btnStats');

            const filtersContainer = document.getElementById('filtersContainer'); // Changed from dateFilter
            const statsUpcoming = document.getElementById('statsUpcoming');
            const statsHistory = document.getElementById('statsHistory');

            const racesContainer = document.getElementById('racesContainer');
            const statsView = document.getElementById('statsView');

            // Reset all buttons
            const activeClass = "px-4 py-1.5 rounded-full text-sm font-bold bg-white text-black transition";
            const inactiveClass = "px-4 py-1.5 rounded-full text-sm font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";

            if (btnUpcoming) btnUpcoming.className = (mode === 'upcoming') ? activeClass : inactiveClass;
            if (btnHistory) btnHistory.className = (mode === 'history') ? activeClass : inactiveClass;
            if (btnStats) btnStats.className = (mode === 'stats') ? activeClass : inactiveClass;

            // Container Visibility
            if (mode === 'stats') {
                if (racesContainer) racesContainer.classList.add('hidden');
                if (filtersContainer) filtersContainer.style.display = 'none';
                if (statsUpcoming) statsUpcoming.classList.add('hidden');
                if (statsHistory) statsHistory.classList.add('hidden');
                if (statsView) statsView.classList.remove('hidden');

                renderStats();
            } else {
                if (statsView) statsView.classList.add('hidden');
                if (racesContainer) racesContainer.classList.remove('hidden');

                if (mode === 'upcoming') {
                    if (filtersContainer) filtersContainer.style.display = 'flex';
                    if (statsUpcoming) statsUpcoming.classList.remove('hidden');
                    if (statsHistory) statsHistory.classList.add('hidden');
                    document.getElementById('noRacesState').classList.add('hidden');
                } else {
                    if (filtersContainer) filtersContainer.style.display = 'none';
                    if (statsUpcoming) statsUpcoming.classList.add('hidden');
                    if (statsHistory) statsHistory.classList.remove('hidden');
                }

                if (typeof renderRaces === 'function') {
                    renderRaces();
                }
            }
        }

        // Render Stats
        function renderStats() {
            // 1. Filter for Resulted Races with valid SPs
            // Matches logic in renderRaces history calculation: resulted or top_2 calculated
            const resultedRaces = cachedRaces.filter(race =>
                race.status === 'resulted' || race.top_2_in_top_2 !== null
            );

            // Data Structures
            const fieldSizes = [4, 5, 6, 7, 8];
            const stats = {
                general: {}, // By Field Size
                short: {},   // By Field Size (< $2.00)
                boxGeneral: {}, // By Box (1-8) -> Field Size
                boxShort: {},   // By Box (1-8) -> Field Size
                tracks: {},      // By Track Name
                distances: {}    // By Distance (300m, 400m, etc.)
            };

            // Initialize Grid structures
            fieldSizes.forEach(size => {
                stats.general[size] = { races: 0, wins: 0 };
                stats.short[size] = { races: 0, wins: 0 };
            });

            for (let b = 1; b <= 8; b++) {
                stats.boxGeneral[b] = {};
                stats.boxShort[b] = {};
                fieldSizes.forEach(size => {
                    stats.boxGeneral[b][size] = { runs: 0, wins: 0 };
                    stats.boxShort[b][size] = { runs: 0, wins: 0 };
                });
            }

            // Process Races
            resultedRaces.forEach(race => {
                const runnerCount = race.active_runner_count;
                if (!fieldSizes.includes(runnerCount)) return;

                const runners = race.runners || [];
                // Filter valid runners with SP
                const validRunners = runners.filter(r => r.starting_price !== null && r.starting_price > 0 && !r.is_scratched);
                if (validRunners.length === 0) return;

                // Find Min SP (Favourites)
                const minSP = Math.min(...validRunners.map(r => r.starting_price));
                const favourites = validRunners.filter(r => r.starting_price === minSP);
                const isShortPriced = minSP < 2.00;

                // Track Stats Init
                if (!stats.tracks[race.meeting_name]) {
                    stats.tracks[race.meeting_name] = {
                        races: 0, favWins: 0, shortWins: 0, shortRaces: 0,
                        top2in2: 0, races4: 0, top2in2_4: 0,
                        box1FavRuns: 0, box1FavWins: 0,
                        box1ShortFavRuns: 0, box1ShortFavWins: 0
                    };
                }
                stats.tracks[race.meeting_name].races++;
                if (isShortPriced) stats.tracks[race.meeting_name].shortRaces++;

                // Distance Stats Init & Increment
                const distKey = race.distance_meters ? `${race.distance_meters}m` : 'Unknown';
                if (!stats.distances[distKey]) {
                    stats.distances[distKey] = {
                        races: 0, favWins: 0, shortWins: 0, shortRaces: 0,
                        top2in2: 0, races4: 0, top2in2_4: 0,
                        box1FavRuns: 0, box1FavWins: 0,
                        box1ShortFavRuns: 0, box1ShortFavWins: 0,
                        rawDist: race.distance_meters || 9999
                    };
                }
                stats.distances[distKey].races++;
                if (isShortPriced) stats.distances[distKey].shortRaces++;

                // Track Stats: Top 2 in Top 2
                if (race.top_2_in_top_2 === true) {
                    stats.tracks[race.meeting_name].top2in2++;
                    stats.distances[distKey].top2in2++;
                }

                // Track Stats: 4 Runner Specifics
                if (runnerCount === 4) {
                    stats.tracks[race.meeting_name].races4++;
                    stats.distances[distKey].races4++;
                    if (race.top_2_in_top_2 === true) {
                        stats.tracks[race.meeting_name].top2in2_4++;
                        stats.distances[distKey].top2in2_4++;
                    }
                }

                // General Stats
                stats.general[runnerCount].races++;
                if (isShortPriced) stats.short[runnerCount].races++;

                // Check Win
                let favWon = false;
                favourites.forEach(fav => {
                    // Update Box Stats (Runs)
                    if (stats.boxGeneral[fav.box_number]) {
                        stats.boxGeneral[fav.box_number][runnerCount].runs++;
                        if (isShortPriced) stats.boxShort[fav.box_number][runnerCount].runs++;
                    }

                    // Track & Distance Stats: Box 1 Favs
                    if (fav.box_number === 1) {
                        stats.tracks[race.meeting_name].box1FavRuns++;
                        stats.distances[distKey].box1FavRuns++;
                        if (isShortPriced) {
                            stats.tracks[race.meeting_name].box1ShortFavRuns++;
                            stats.distances[distKey].box1ShortFavRuns++;
                        }
                    }

                    if (fav.finishing_position === 1) {
                        favWon = true;
                        // Update Box Stats (Wins)
                        if (stats.boxGeneral[fav.box_number]) {
                            stats.boxGeneral[fav.box_number][runnerCount].wins++;
                            if (isShortPriced) stats.boxShort[fav.box_number][runnerCount].wins++;
                        }

                        // Track & Distance Stats: Box 1 Fav Wins
                        if (fav.box_number === 1) {
                            stats.tracks[race.meeting_name].box1FavWins++;
                            stats.distances[distKey].box1FavWins++;
                            if (isShortPriced) {
                                stats.tracks[race.meeting_name].box1ShortFavWins++;
                                stats.distances[distKey].box1ShortFavWins++;
                            }
                        }
                    }
                });

                if (favWon) {
                    stats.general[runnerCount].wins++;
                    stats.tracks[race.meeting_name].favWins++;
                    stats.distances[distKey].favWins++;
                    if (isShortPriced) {
                        stats.short[runnerCount].wins++;
                        stats.tracks[race.meeting_name].shortWins++;
                        stats.distances[distKey].shortWins++;
                    }
                }
            });

            // --- HTML Generation Helpers ---
            const calcPct = (wins, total) => total > 0 ? ((wins / total) * 100).toFixed(1) + '%' : '-';
            const rateClass = (wins, total) => {
                if (total === 0) return 'text-zinc-500'; // Was zinc-600
                const pct = (wins / total) * 100;
                if (pct >= 50) return 'text-green-400 font-bold';
                if (pct >= 40) return 'text-green-300'; // Was green-200 (pastel), 300 is slightly more vibrant green
                if (pct >= 30) return 'text-zinc-300';
                return 'text-zinc-400'; // Was zinc-500
            };

            // 1. General & Short Tables
            const renderTableRows = (dataObj, targetId) => {
                const tbody = document.getElementById(targetId);
                if (!tbody) return;
                let html = '';
                let totalRaces = 0;
                let totalWins = 0;

                fieldSizes.forEach(size => {
                    const d = dataObj[size];
                    totalRaces += d.races;
                    totalWins += d.wins;

                    html += `
                        <tr class="hover:bg-white/5 transition">
                            <td class="px-4 py-3 font-medium text-white">${size} Runners</td>
                            <td class="px-4 py-3 text-center text-zinc-400">${d.races}</td>
                            <td class="px-4 py-3 text-center text-zinc-300">${d.wins}</td>
                            <td class="px-4 py-3 text-right ${rateClass(d.wins, d.races)}">${calcPct(d.wins, d.races)}</td>
                        </tr>
                    `;
                });

                // Add Total Row
                html += `
                    <tr class="bg-zinc-800/50 font-bold border-t border-zinc-700">
                        <td class="px-4 py-3 text-white">All Field Sizes</td>
                        <td class="px-4 py-3 text-center text-white">${totalRaces}</td>
                        <td class="px-4 py-3 text-center text-white">${totalWins}</td>
                        <td class="px-4 py-3 text-right ${rateClass(totalWins, totalRaces)}">${calcPct(totalWins, totalRaces)}</td>
                    </tr>
                `;

                tbody.innerHTML = html;
            };
            renderTableRows(stats.general, 'statsFavGeneral');
            renderTableRows(stats.short, 'statsFavShort');

            // 2. Box Matrix
            const renderBoxMatrix = (dataObj, targetId) => {
                const tbody = document.getElementById(targetId);
                if (!tbody) return;
                let html = '';
                for (let b = 1; b <= 8; b++) {
                    let rowHtml = `<tr><td class="px-2 py-2 font-bold box-${b} text-black w-8 text-center rounded-sm">${b}</td>`;

                    let totalRuns = 0;
                    let totalWins = 0;

                    fieldSizes.forEach(size => {
                        const d = dataObj[b][size];
                        totalRuns += d.runs;
                        totalWins += d.wins;

                        const pct = d.runs > 0 ? Math.round((d.wins / d.runs) * 100) : 0;
                        const cellContent = d.runs > 0
                            ? `<div class="flex flex-col items-center"><span class="text-xs font-bold ${pct >= 40 ? 'text-green-400' : 'text-zinc-200'}">${d.wins}/${d.runs}</span><span class="text-[9px] text-zinc-400">${pct}%</span></div>`
                            : '<span class="text-zinc-600">-</span>';
                        rowHtml += `<td class="px-2 py-2 border-l border-zinc-800/50 text-center">${cellContent}</td>`;
                    });

                    // Add Total Column
                    const totalPct = totalRuns > 0 ? Math.round((totalWins / totalRuns) * 100) : 0;
                    const totalContent = totalRuns > 0
                        ? `<div class="flex flex-col items-center"><span class="text-xs font-bold ${totalPct >= 40 ? 'text-green-400' : 'text-zinc-200'}">${totalWins}/${totalRuns}</span><span class="text-[9px] text-zinc-400">${totalPct}%</span></div>`
                        : '<span class="text-zinc-600">-</span>';
                    rowHtml += `<td class="px-2 py-2 border-l border-zinc-700 text-center bg-zinc-800/30">${totalContent}</td>`;

                    rowHtml += '</tr>';
                    html += rowHtml;
                }
                tbody.innerHTML = html;
            };
            renderBoxMatrix(stats.boxGeneral, 'statsBoxAll');
            renderBoxMatrix(stats.boxShort, 'statsBoxShort');

            // 3. Track Stats
            // Global sort state
            if (!window.trackSort) window.trackSort = { field: 'favRate', dir: 'desc' };

            const renderTrackTable = () => {
                const tracksBody = document.getElementById('statsTracks');
                if (!tracksBody) return;

                const sortedTracks = Object.entries(stats.tracks)
                    .map(([name, d]) => ({
                        name,
                        ...d,
                        favRate: d.races > 0 ? (d.favWins / d.races) * 100 : 0,
                        shortFavRate: d.shortRaces > 0 ? (d.shortWins / d.shortRaces) * 100 : 0,
                        top2in2Rate: d.races > 0 ? (d.top2in2 / d.races) * 100 : 0,
                        top2in2Rate4: d.races4 > 0 ? (d.top2in2_4 / d.races4) * 100 : 0,
                        box1FavRate: d.box1FavRuns > 0 ? (d.box1FavWins / d.box1FavRuns) * 100 : 0,
                        box1ShortFavRate: d.box1ShortFavRuns > 0 ? (d.box1ShortFavWins / d.box1ShortFavRuns) * 100 : 0
                    }))
                    .filter(t => t.races >= 1)
                    .sort((a, b) => {
                        const field = window.trackSort.field;
                        const dir = window.trackSort.dir === 'asc' ? 1 : -1;

                        if (field === 'name') return a.name.localeCompare(b.name) * dir;
                        return (a[field] - b[field]) * dir;
                    });

                // Helper for headers
                const sortIcon = (f) => window.trackSort.field === f ? (window.trackSort.dir === 'asc' ? ' ‚Üë' : ' ‚Üì') : '';
                const th = (label, field, center = true) => `
                    <th class="px-2 py-3 ${center ? 'text-center' : 'text-left'} cursor-pointer hover:text-white transition group" 
                        onclick="window.trackSort = { field: '${field}', dir: window.trackSort.field === '${field}' && window.trackSort.dir === 'desc' ? 'asc' : 'desc' }; renderStats();">
                        <div class="flex items-center ${center ? 'justify-center' : ''} gap-1">
                            ${label} <span class="text-[10px] opacity-30 group-hover:opacity-100">${sortIcon(field)}</span>
                        </div>
                    </th>`;

                // Header Header
                const table = document.getElementById('statsTracks').closest('table');
                const thead = table ? table.querySelector('thead tr') : null;
                if (thead) {
                    thead.innerHTML = `
                        ${th('Track', 'name', false)}
                        ${th('Races', 'races')}
                        ${th('Fav Wins', 'favWins')}
                        ${th('Fav SR%', 'favRate')}
                        ${th('Short Wins', 'shortWins')}
                        ${th('Short SR%', 'shortFavRate')}
                        ${th('T2inT2 %', 'top2in2Rate')}
                        ${th('4-Run Count', 'races4')}
                        ${th('Top2in2 (4)', 'top2in2Rate4')}
                        ${th('Box 1 Fav Wins', 'box1FavWins')}
                        ${th('Box 1 Fav %', 'box1FavRate')}
                        ${th('Box 1 Short Wins', 'box1ShortFavWins')}
                        ${th('Box 1 Short %', 'box1ShortFavRate')}
                    `;
                }

                tracksBody.innerHTML = sortedTracks.map(t => `
                    <tr class="hover:bg-white/5 transition border-b border-zinc-800/30 last:border-0">
                        <td class="px-2 py-3 font-medium text-white truncate max-w-[120px]">${t.name}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.races}</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.favWins}</td>
                        <td class="px-2 py-3 text-center font-bold ${t.favRate >= 40 ? 'text-green-400' : 'text-zinc-400'}">${t.favRate.toFixed(1)}%</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.shortWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.shortRaces > 0 ? t.shortFavRate.toFixed(1) + '%' : '-'}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.top2in2Rate.toFixed(1)}%</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.races4}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.races4 > 0 ? t.top2in2Rate4.toFixed(1) + '%' : '-'}</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.box1FavWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.box1FavRuns > 0 ? t.box1FavRate.toFixed(1) + '%' : '-'}</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.box1ShortFavWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.box1ShortFavRuns > 0 ? t.box1ShortFavRate.toFixed(1) + '%' : '-'}</td>
                    </tr>
                `).join('');
            };
            renderTrackTable();

            // 4. Distance Stats Render
            // Global sort state for distance
            if (!window.distSort) window.distSort = { field: 'rawDist', dir: 'asc' }; // Default by Distance (Shortest first)

            const renderDistanceTable = () => {
                const tbody = document.getElementById('statsDistances');
                if (!tbody) return;

                const sortedDistances = Object.entries(stats.distances)
                    .map(([name, d]) => ({
                        name,
                        ...d,
                        favRate: d.races > 0 ? (d.favWins / d.races) * 100 : 0,
                        shortFavRate: d.shortRaces > 0 ? (d.shortWins / d.shortRaces) * 100 : 0,
                        top2in2Rate: d.races > 0 ? (d.top2in2 / d.races) * 100 : 0,
                        top2in2Rate4: d.races4 > 0 ? (d.top2in2_4 / d.races4) * 100 : 0,
                        box1FavRate: d.box1FavRuns > 0 ? (d.box1FavWins / d.box1FavRuns) * 100 : 0,
                        box1ShortFavRate: d.box1ShortFavRuns > 0 ? (d.box1ShortFavWins / d.box1ShortFavRuns) * 100 : 0
                    }))
                    .filter(t => t.races >= 1)
                    .sort((a, b) => {
                        const field = window.distSort.field;
                        const dir = window.distSort.dir === 'asc' ? 1 : -1;

                        if (field === 'name') return a.name.localeCompare(b.name) * dir;
                        return (a[field] - b[field]) * dir;
                    });

                // Helper for headers
                const sortIcon = (f) => window.distSort.field === f ? (window.distSort.dir === 'asc' ? ' ‚Üë' : ' ‚Üì') : '';
                const th = (label, field, center = true) => `
                    <th class="px-2 py-3 ${center ? 'text-center' : 'text-left'} cursor-pointer hover:text-white transition group" 
                        onclick="window.distSort = { field: '${field}', dir: window.distSort.field === '${field}' && window.distSort.dir === 'desc' ? 'asc' : 'desc' }; renderStats();">
                        <div class="flex items-center ${center ? 'justify-center' : ''} gap-1">
                            ${label} <span class="text-[10px] opacity-30 group-hover:opacity-100">${sortIcon(field)}</span>
                        </div>
                    </th>`;

                // Render Header
                const table = document.getElementById('statsDistances').closest('table');
                const thead = table ? table.querySelector('thead tr') : null;
                if (thead) {
                    thead.innerHTML = `
                        ${th('Distance', 'rawDist', true)}
                        ${th('Races', 'races')}
                        ${th('Fav Wins', 'favWins')}
                        ${th('Fav SR%', 'favRate')}
                        ${th('Short Wins', 'shortWins')}
                        ${th('Short SR%', 'shortFavRate')}
                        ${th('T2inT2 %', 'top2in2Rate')}
                        ${th('4-Run Count', 'races4')}
                        ${th('Top2in2 (4)', 'top2in2Rate4')}
                        ${th('Box 1 Fav Wins', 'box1FavWins')}
                        ${th('Box 1 Fav %', 'box1FavRate')}
                        ${th('Box 1 Short Wins', 'box1ShortFavWins')}
                        ${th('Box 1 Short %', 'box1ShortFavRate')}
                    `;
                }

                tbody.innerHTML = sortedDistances.map(t => `
                    <tr class="hover:bg-white/5 transition border-b border-zinc-800/30 last:border-0">
                        <td class="px-2 py-3 font-medium text-white text-center">${t.name}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.races}</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.favWins}</td>
                        <td class="px-2 py-3 text-center font-bold ${t.favRate >= 40 ? 'text-green-400' : 'text-zinc-400'}">${t.favRate.toFixed(1)}%</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.shortWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.shortRaces > 0 ? t.shortFavRate.toFixed(1) + '%' : '-'}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.top2in2Rate.toFixed(1)}%</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.races4}</td>
                        <td class="px-2 py-3 text-center text-zinc-300">${t.races4 > 0 ? t.top2in2Rate4.toFixed(1) + '%' : '-'}</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.box1FavWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.box1FavRuns > 0 ? t.box1FavRate.toFixed(1) + '%' : '-'}</td>
                        <td class="px-2 py-3 text-center text-zinc-200 font-mono">${t.box1ShortFavWins}</td>
                        <td class="px-2 py-3 text-center text-zinc-400">${t.box1ShortFavRuns > 0 ? t.box1ShortFavRate.toFixed(1) + '%' : '-'}</td>
                    </tr>
                `).join('');
            };
            renderDistanceTable();

        }
        function setDateFilter(filter) {
            currentDateFilter = filter;
            // Update buttons
            const btnAll = document.getElementById('btnAll');
            const btnToday = document.getElementById('btnToday');
            const btnTomorrow = document.getElementById('btnTomorrow');

            if (btnAll && btnToday && btnTomorrow) {
                // Reset all buttons
                btnAll.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";
                btnToday.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";
                btnTomorrow.className = "px-3 py-1 rounded-full text-xs font-bold bg-zinc-800 text-zinc-400 hover:bg-zinc-700 transition";

                // Highlight selected button
                if (filter === 'all') {
                    btnAll.className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                } else if (filter === 'today') {
                    btnToday.className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                } else if (filter === 'tomorrow') {
                    btnTomorrow.className = "px-3 py-1 rounded-full text-xs font-bold bg-white text-black transition";
                }
            }

            if (typeof renderRaces === 'function') {
                renderRaces();
            }
        }

        // Format countdown timer
        function formatCountdown(raceTime) {
            const now = new Date();
            const race = new Date(raceTime);
            const diff = race - now;

            if (diff < 0) {
                return 'FINISHED';
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Format race time
        function formatRaceTime(raceTime) {
            const date = new Date(raceTime);
            return date.toLocaleTimeString('en-AU', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Format date label (Today/Tomorrow)
        function formatDateLabel(raceTime) {
            if (!raceTime) return '';
            // Convert to local date string (YYYY-MM-DD)
            const raceDate = new Date(raceTime);
            const dateStr = raceDate.toLocaleDateString('en-CA');

            const now = new Date();
            const today = now.toLocaleDateString('en-CA');

            // Calculate tomorrow
            const tmr = new Date(now);
            tmr.setDate(tmr.getDate() + 1);
            const tomorrow = tmr.toLocaleDateString('en-CA');

            if (dateStr === today) {
                return 'Today';
            } else if (dateStr === tomorrow) {
                return 'Tomorrow';
            } else {
                return dateStr; // Fallback to YYYY-MM-DD
            }
        }

        // Check for Blue Opportunity
        function isRaceBlueOpp(race) {
            // 2 favs < $3, rest > $10
            const activeRunnersArr = (race.runners || []).filter(r => !r.is_scratched);
            const runnersWithOdds = activeRunnersArr.filter(r => r.sportsbet_odds > 0);
            const hasEnoughData = runnersWithOdds.length >= 2;

            if (hasEnoughData && race.active_runner_count >= 5 && race.active_runner_count <= 8) {
                const shortFavs = activeRunnersArr.filter(r => r.sportsbet_odds > 0 && r.sportsbet_odds < 3.00);
                if (shortFavs.length === 2) {
                    const others = activeRunnersArr.filter(r => r.sportsbet_odds > 0 && r.sportsbet_odds >= 3.00);
                    const othersAreLong = others.every(r => r.sportsbet_odds >= 8.00);
                    if (others.length > 0 && othersAreLong) {
                        return true;
                    }
                }
            }
            return false;
        }

        // Format Money: Remove decimals if whole number (e.g. $61), else 2 decimals ($2.50)
        function formatMoney(val) {
            if (val === null || val === undefined) return '-';
            const num = parseFloat(val);
            if (isNaN(num)) return '-';
            if (num % 1 === 0) return `$${num.toFixed(0)}`;
            return `$${num.toFixed(2)}`;
        }

        // Create race card HTML
        function createRaceCard(race, runners, isBlueOpp = false) {
            const isMicroField = race.active_runner_count === 4;
            const isResulted = race.status === 'resulted' || (race.top_2_in_top_2 !== null);

            const cardClass = isMicroField ? 'micro-field-card' : 'opportunity-card';
            // Badge text is now just the runner count
            let badgeText = isMicroField ? '4 RUNNERS' : '5 RUNNERS';
            let badgeColor = isMicroField ? 'bg-red-900' : 'bg-orange-900';

            // Blue Opportunity Override (High Confidence)
            let finalCardClass = cardClass;
            if (isBlueOpp) {
                finalCardClass = 'bg-blue-900/40 border border-blue-500/30 hover:bg-blue-900/60 hover:border-blue-400/50 hover:shadow-blue-900/20';
                badgeText = `${race.active_runner_count} RUNNERS - TOP 2 OPP`;
                badgeColor = 'bg-blue-600';
            }

            // Sort logic
            let sortedRunners = [...runners];
            if (isResulted) {
                // Sort by finishing position (1, 2, 3...) then box
                sortedRunners.sort((a, b) => {
                    // Pull nulls/undefined to the bottom
                    const posA = a.finishing_position || 999;
                    const posB = b.finishing_position || 999;
                    if (posA !== posB) return posA - posB;
                    // Tie-breaker: box number
                    return a.box_number - b.box_number;
                });
            } else {
                // Default: Sort by box number
                sortedRunners.sort((a, b) => a.box_number - b.box_number);
            }

            const runnersHTML = sortedRunners.map(runner => {
                const scratchedClass = runner.is_scratched ? 'opacity-50 line-through' : '';
                const ghrOddsText = formatMoney(runner.ghr_odds);

                // For resulted races, show SP. For upcoming, show SB fixed odds.
                let secondOddsLabel = 'SB';
                let secondOddsText = formatMoney(runner.sportsbet_odds);
                let secondOddsClass = 'text-blue-300'; // Default SB blue

                if (isResulted) {
                    secondOddsLabel = 'SP';
                    secondOddsText = formatMoney(runner.starting_price);
                    secondOddsClass = 'text-yellow-300'; // SP in yellow/gold
                }

                const boxClass = `box-${runner.box_number}`;

                // Position Indicator (Gold/Silver/Bronze)
                let posIndicator = '';
                if (isResulted && runner.finishing_position) {
                    if (runner.finishing_position === 1) {
                        posIndicator = `<div class="w-4 text-center font-bold text-yellow-400 mr-1 text-[10px]">1st</div>`;
                    } else if (runner.finishing_position === 2) {
                        posIndicator = `<div class="w-4 text-center font-bold text-zinc-400 mr-1 text-[10px]">2nd</div>`;
                    } else if (runner.finishing_position === 3) {
                        posIndicator = `<div class="w-4 text-center font-bold text-amber-700 mr-1 text-[10px]">3rd</div>`;
                    } else {
                        // Spacer for non-placed runners to align boxes
                        posIndicator = `<div class="w-4 mr-1"></div>`;
                    }
                }

                return `
                    <div class="flex items-center justify-between py-0.5 border-b border-white/5 last:border-0 ${scratchedClass}">
                        <div class="flex items-center min-w-0">
                            ${posIndicator}
                            <div class="w-4 h-4 rounded-full ${boxClass} flex items-center justify-center font-bold text-[9px] flex-shrink-0 mr-1.5">
                                ${runner.box_number}
                            </div>
                            <div class="font-medium text-xs text-white/90 truncate pr-1">${runner.dog_name}</div>
                        </div>
                        <div class="flex gap-1.5 items-center flex-shrink-0">
                            <div class="text-right w-[28px]">
                                <div class="text-[8px] text-white/40 leading-none">GHR</div>
                                <div class="font-bold text-[10px] leading-tight">${ghrOddsText}</div>
                            </div>
                            <div class="text-right w-[28px]">
                                <div class="text-[8px] text-white/40 leading-none">${secondOddsLabel}</div>
                                <div class="font-bold text-[10px] leading-tight ${secondOddsClass}">${secondOddsText}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Resulted Label
            const resultedLabel = isResulted ?
                `<span class="ml-2 text-[10px] bg-green-900/80 text-green-300 px-1.5 py-0.5 rounded uppercase tracking-wider font-bold">Resulted</span>`
                : '';

            return `
                <div class="${finalCardClass} rounded-lg p-2 text-white transform transition hover:scale-[1.01] hover:shadow-lg">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-1.5 min-w-0 flex-1">
                            <div class="text-[9px] ${badgeColor} px-1.5 rounded-sm text-white/90 font-bold uppercase tracking-wider flex-shrink-0">
                                ${badgeText}
                            </div>
                            <h2 class="text-xs font-bold leading-tight truncate text-white/90">
                                ${race.meeting_name} ${race.race_number} ${race.distance_meters ? `<span class="opacity-60 font-normal ml-1">${race.distance_meters}m</span>` : ''}
                            </h2>
                        </div>
                        <div class="text-right pl-1 flex-shrink-0 flex items-center gap-2">
                            <div class="text-xs font-bold whitespace-nowrap opacity-75">
                                ${formatDateLabel(race.race_time)}
                            </div>
                            ${resultedLabel}
                        </div>
                    </div>
                    
                    <div class="bg-black/20 rounded-md px-1.5 py-0.5 backdrop-blur-sm">
                        ${runnersHTML}
                    </div>
                </div>
            `;
        }

        // Update countdown timers
        function updateCountdowns() {
            const countdownElements = document.querySelectorAll('.countdown');
            countdownElements.forEach(elem => {
                const raceTime = elem.getAttribute('data-race-time');
                elem.textContent = formatCountdown(raceTime);
            });
        }

        // Render Races based on current view info
        function renderRaces() {
            const container = document.getElementById('racesContainer');
            if (!container) return;
            container.innerHTML = '';

            // Filter based on view
            // Use local date for "Today" comparison
            // To be safe, we use the device's local midnight
            // Reset to midnight for comparison by using local YYYY-MM-DD string
            const now = new Date();
            // toLocaleDateString('en-CA') returns "YYYY-MM-DD" in local time
            // This ensures "Today" matches even if UTC date is yesterday
            const todayStr = now.toLocaleDateString('en-CA');

            // Calculate tomorrow's date
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toLocaleDateString('en-CA');

            let displayRaces = cachedRaces.filter(race => {
                // race_time is ISO string
                if (!race.race_time) return false;

                // Convert UTC race time to local date string for comparison
                const raceDateStr = new Date(race.race_time).toLocaleDateString('en-CA');

                // Filter by view (upcoming vs history)
                let passesViewFilter = false;
                if (currentView === 'upcoming') {
                    passesViewFilter = raceDateStr >= todayStr;
                } else {
                    passesViewFilter = raceDateStr < todayStr;
                }

                if (!passesViewFilter) return false;

                // Blue Opportunity Logic (2 favs < $3, rest > $10)
                // Filter scratches first
                const activeRunnersArr = (race.runners || []).filter(r => !r.is_scratched);

                // Only consider if we have data (at least 2 runners have odds)
                const runnersWithOdds = activeRunnersArr.filter(r => r.sportsbet_odds > 0);
                const hasEnoughData = runnersWithOdds.length >= 2;

                let isBlueOpp = false;
                if (hasEnoughData && race.active_runner_count >= 5 && race.active_runner_count <= 8) {
                    const shortFavs = activeRunnersArr.filter(r => r.sportsbet_odds > 0 && r.sportsbet_odds < 3.00);
                    // Check if others are long shots (either > $10 OR no odds data, we assume market corrects eventually, but for safety check known odds)
                    // Strict logic: All active runners EXCEPT the short favs must be >= 10.

                    if (shortFavs.length === 2) {
                        const others = activeRunnersArr.filter(r => r.sportsbet_odds > 0 && r.sportsbet_odds >= 3.00);
                        const othersAreLong = others.every(r => r.sportsbet_odds >= 8.00);

                        // Also ensure we actually HAVE others to beat
                        if (others.length > 0 && othersAreLong) {
                            isBlueOpp = true;
                        }
                    }
                }

                // Tag for sort
                race.isBlueOpp = isBlueOpp;

                // Filter by runner count (only show 4-5 runners OR Blue Opportunities)
                if (![4, 5].includes(race.active_runner_count) && !isBlueOpp) {
                    return false;
                }

                // Filter by Date (Today/Tomorrow/All) - ONLY applied in UPCOMING view
                if (currentView === 'upcoming' && currentDateFilter !== 'all') {
                    if (currentDateFilter === 'today') {
                        if (raceDateStr !== todayStr) return false;
                    } else if (currentDateFilter === 'tomorrow') {
                        if (raceDateStr !== tomorrowStr) return false;
                    }
                }

                return true;
            });

            // Handle empty state
            document.getElementById('noRacesState').classList.add('hidden');
            if (displayRaces.length === 0) {
                document.getElementById('noRacesState').classList.remove('hidden');
                document.getElementById('microFieldCount').textContent = '0';
                document.getElementById('opportunityCount').textContent = '0';
                return; // Nothing else to do
            }

            // Stats Calculation (Global based on cachedRaces, not just view)
            // We want to show stats for "Upcoming" races usually
            // But user asked for breakdown. Let's calculate based on ALL cached races that are Future or Today

            const statsRaces = cachedRaces.filter(race => {
                const rDate = new Date(race.race_time).toLocaleDateString('en-CA');
                return rDate >= todayStr; // Only count Today & Future for the dashboard
            });

            function countStats(runnerCount) {
                const total = statsRaces.filter(r => r.active_runner_count === runnerCount).length;
                const todayCount = statsRaces.filter(r => r.active_runner_count === runnerCount && new Date(r.race_time).toLocaleDateString('en-CA') === todayStr).length;
                // Anything > todayStr is tomorrow+
                const tomorrowCount = statsRaces.filter(r => r.active_runner_count === runnerCount && new Date(r.race_time).toLocaleDateString('en-CA') > todayStr).length;
                return { total, todayCount, tomorrowCount };
            }

            function countBlueStats() {
                const blueRaces = statsRaces.filter(r => isRaceBlueOpp(r));
                const total = blueRaces.length;
                const todayCount = blueRaces.filter(r => new Date(r.race_time).toLocaleDateString('en-CA') === todayStr).length;
                const tomorrowCount = blueRaces.filter(r => new Date(r.race_time).toLocaleDateString('en-CA') > todayStr).length;
                return { total, todayCount, tomorrowCount };
            }

            const stats4 = countStats(4);
            const stats5 = countStats(5);
            const statsBlue = countBlueStats();

            document.getElementById('stats4Total').textContent = stats4.total;
            document.getElementById('stats4Today').textContent = stats4.todayCount;
            document.getElementById('stats4Tomorrow').textContent = stats4.tomorrowCount;

            document.getElementById('stats5Total').textContent = stats5.total;
            document.getElementById('stats5Today').textContent = stats5.todayCount;
            document.getElementById('stats5Tomorrow').textContent = stats5.tomorrowCount;

            document.getElementById('statsBlueTotal').textContent = statsBlue.total;
            document.getElementById('statsBlueToday').textContent = statsBlue.todayCount;
            document.getElementById('statsBlueTomorrow').textContent = statsBlue.tomorrowCount;

            // History Stats - Top 2 in Top 2 Strike Rates
            if (currentView === 'history') {
                const historyRaces = cachedRaces.filter(race => {
                    const rDate = new Date(race.race_time).toLocaleDateString('en-CA');
                    return rDate < todayStr && race.top_2_in_top_2 !== null; // Only historical races with results
                });

                function calculateStrikeRate(runnerCount) {
                    const races = historyRaces.filter(r => r.active_runner_count === runnerCount);
                    const total = races.length;
                    const successes = races.filter(r => r.top_2_in_top_2 === true).length;
                    const percentage = total > 0 ? ((successes / total) * 100).toFixed(1) : 0;
                    return { successes, total, percentage };
                }

                const history4 = calculateStrikeRate(4);
                const history5 = calculateStrikeRate(5);
                const history6 = calculateStrikeRate(6);
                const history7 = calculateStrikeRate(7);
                const history8 = calculateStrikeRate(8);

                // All fields combined
                const allTotal = historyRaces.length;
                const allSuccesses = historyRaces.filter(r => r.top_2_in_top_2 === true).length;
                const allPercentage = allTotal > 0 ? ((allSuccesses / allTotal) * 100).toFixed(1) : 0;

                // Update DOM
                document.getElementById('statsHistory4').textContent = `${history4.successes}/${history4.total}`;
                document.getElementById('statsHistory4Pct').textContent = `${history4.percentage}%`;

                document.getElementById('statsHistory5').textContent = `${history5.successes}/${history5.total}`;
                document.getElementById('statsHistory5Pct').textContent = `${history5.percentage}%`;

                document.getElementById('statsHistory6').textContent = `${history6.successes}/${history6.total}`;
                document.getElementById('statsHistory6Pct').textContent = `${history6.percentage}%`;

                document.getElementById('statsHistory7').textContent = `${history7.successes}/${history7.total}`;
                document.getElementById('statsHistory7Pct').textContent = `${history7.percentage}%`;

                document.getElementById('statsHistory8').textContent = `${history8.successes}/${history8.total}`;
                document.getElementById('statsHistory8Pct').textContent = `${history8.percentage}%`;

                document.getElementById('statsHistoryAll').textContent = `${allSuccesses}/${allTotal}`;
                document.getElementById('statsHistoryAllPct').textContent = `${allPercentage}%`;
            }

            // Handle empty state for list
            document.getElementById('noRacesState').classList.add('hidden');
            if (displayRaces.length === 0) {
                document.getElementById('noRacesState').classList.remove('hidden');
                return;
            }

            // Sort logic: Micro-Fields (4) FIRST, then 5s, then Blue Opps (by virtue of being >5)
            // But we filter list to [4, 5, BlueOpps]
            // If we sort by active_runner_count, we get 4, 5, 6/7/8.
            // This satisfies the requirement: "Blue Opps... last on the sorting after 4 runners and 5 runners"
            const sortedRaces = displayRaces.sort((a, b) => {
                // Priority 1: Field Size (Smallest first)
                if (a.active_runner_count !== b.active_runner_count) {
                    return a.active_runner_count - b.active_runner_count;
                }

                // Second: Sort by date
                const dateA = new Date(a.race_time).toLocaleDateString('en-CA');
                const dateB = new Date(b.race_time).toLocaleDateString('en-CA');
                if (dateA !== dateB) return dateA.localeCompare(dateB);

                // Third: group by meeting name
                if (a.meeting_name !== b.meeting_name) return a.meeting_name.localeCompare(b.meeting_name);

                // Fourth: race number
                return a.race_number - b.race_number;
            });

            // Add cards
            sortedRaces.forEach(race => {
                const raceRunners = (race.runners || []).sort((a, b) => a.box_number - b.box_number);
                container.innerHTML += createRaceCard(race, raceRunners, race.isBlueOpp);
            });
        }

        // Fetch Races from Supabase
        async function fetchRaces() {
            if (!supabaseClient) return; // Don't try if initialization failed
            console.log('Fetching races...');
            try {
                // Show loading state only if no cache
                const loading = document.getElementById('loadingState');
                if (cachedRaces.length === 0) loading.classList.remove('hidden');

                document.getElementById('errorState').classList.add('hidden');

                // Query races with their runners
                // Fetch all races (not just 4-5) so we can show strike rates for all runner counts in History
                const { data: races, error: racesError } = await supabaseClient
                    .from('races')
                    .select('*, runners(*)')  // Optimized join
                    .order('race_time', { ascending: true });

                if (racesError) throw racesError;

                // Update cache
                cachedRaces = races || [];

                // Hide loading state
                loading.classList.add('hidden');

                // Render with current view
                renderRaces();

                // Update last updated time
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('en-AU');

                // Start countdown timer
                clearInterval(window.countdownInterval);
                window.countdownInterval = setInterval(updateCountdowns, 1000);

            } catch (error) {
                console.error('Error loading races:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('errorState').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchRaces();

            // Refresh data every 2 minutes
            setInterval(fetchRaces, 2 * 60 * 1000);
        });
    </script>

</body>

</html>